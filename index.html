<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ระบบจัดการงาน Real-time (Task Management)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <style>
      :root {
        --sidebar-width: 280px;
      }
      html {
        scroll-behavior: smooth;
      }
      body {
        font-family: "Kanit", sans-serif;
        background-color: #f0f4f8;
        background-image: radial-gradient(#dbeafe 1px, transparent 1px);
        background-size: 20px 20px;
        overflow-x: hidden;
      }
      /* -- Responsive Kanban Board -- */
      .main-content {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        display: flex;
        align-items: flex-start;
      }
      .kanban-board {
        display: flex;
        gap: 1.5rem; /* Default gap for larger screens */
        padding: 1.5rem; /* Default padding */
        min-height: calc(100vh - 120px);
        align-items: flex-start;
        width: max-content;
      }
      .kanban-column {
        width: 320px; /* A consistent width for columns on larger screens */
        flex-shrink: 0; /* Prevent columns from shrinking */
        background-color: #eef2f5;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        max-height: calc(100vh - 180px);
        display: flex;
        flex-direction: column;
        border-top: 4px solid;
      }
      /* On screens smaller than 640px (mobile) */
      @media (max-width: 640px) {
        .kanban-board {
          gap: 1rem; /* Reduce gap */
          padding: 1rem; /* Reduce padding */
        }
        .kanban-column {
          width: 85vw; /* Make columns take up most of the viewport width */
        }
        .add-category-btn-kanban {
          width: 85vw !important;
        }
      }
      .column-header {
        padding: 1rem 1.25rem;
        font-weight: 600;
        color: #1a202c;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .task-list {
        padding: 0.5rem 0.75rem 0.75rem;
        overflow-y: auto;
        flex-grow: 1;
      }
      .task-card {
        background-color: white;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.06);
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        border-left: 5px solid;
        font-size: 0.9rem;
        line-height: 1.6;
      }
      .task-card.status-completed {
        opacity: 0.65;
        background-color: #f9fafb;
      }
      .task-card.status-completed .task-card-content {
        text-decoration: line-through;
      }
      .task-card:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-3px);
      }
      .task-card-content {
        cursor: grab;
      }
      .task-card-content:active {
        cursor: grabbing;
      }
      .task-card.dragging {
        opacity: 0.6;
        transform: rotate(3deg);
      }
      .task-actions {
        position: absolute;
        top: 8px;
        right: 8px;
        display: flex;
        gap: 4px;
        opacity: 0;
        transition: opacity 0.2s ease;
      }
      .task-card:hover .task-actions {
        opacity: 1;
      }
      .task-action-btn {
        background: none;
        border: none;
        color: #9ca3af;
        cursor: pointer;
        width: 28px;
        height: 28px;
        font-size: 0.9rem;
        border-radius: 50%;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      .task-action-btn:hover {
        color: #3b82f6;
        background-color: #eff6ff;
      }
      .task-action-btn.delete:hover {
        color: #ef4444;
        background-color: #fee2e2;
      }
      .task-action-btn.complete:hover,
      .task-action-btn.reopen:hover {
        color: #10b981;
        background-color: #f0fdf4;
      }
      .task-action-btn.start:hover {
        color: #3b82f6;
        background-color: #eff6ff;
      }
      .modal {
        transition: opacity 0.3s ease;
        z-index: 50;
      }
      .task-count {
        background-color: #d1d5db;
        color: #4b5563;
        font-size: 0.75rem;
        font-weight: 500;
        padding: 0.125rem 0.5rem;
        border-radius: 9999px;
      }
      .task-card .highlight-date {
        color: #c026d3;
        font-weight: 600;
      }
      .task-card .highlight-money {
        color: #16a34a;
        font-weight: 600;
        background-color: #f0fdf4;
        padding: 0 4px;
        border-radius: 4px;
      }
      .task-card .highlight-keyword {
        color: #be123c;
        font-weight: 600;
      }
      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        height: 100%;
        width: var(--sidebar-width);
        background-color: #ffffff;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        transform: translateX(calc(var(--sidebar-width) * -1));
        transition: transform 0.3s ease-in-out;
        z-index: 40;
        display: flex;
        flex-direction: column;
      }
      .sidebar.open {
        transform: translateX(0);
      }
      .sidebar-overlay {
        position: fixed;
        inset: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 30;
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
        pointer-events: none;
      }
      .sidebar-overlay.open {
        opacity: 1;
        pointer-events: auto;
      }
      .sidebar-menu {
        list-style: none;
        padding: 0;
        margin: 0;
        overflow-y: auto;
      }
      .sidebar-menu a,
      .sidebar-menu-header {
        display: block;
        padding: 0.75rem 1.5rem;
        color: #374151;
        text-decoration: none;
        transition: background-color 0.2s;
        border-left: 4px solid transparent;
      }
      .sidebar-menu a:hover {
        background-color: #f3f4f6;
        border-left-color: #3b82f6;
      }
      .sidebar-menu a.active {
        background-color: #eff6ff;
        border-left-color: #3b82f6;
        font-weight: 600;
        color: #2563eb;
      }
      .sidebar-menu-header {
        font-weight: 600;
        color: #6b7280;
        font-size: 0.875rem;
        padding-top: 1.5rem;
        padding-bottom: 0.5rem;
        text-transform: uppercase;
      }
      .task-footer {
        margin-top: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #6b7280;
        font-size: 0.8rem;
      }
      .task-meta {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.75rem;
        padding-top: 0.75rem;
        margin-top: 0.75rem;
        border-top: 1px solid #f3f4f6;
        font-size: 0.8rem;
      }
      .meta-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #4b5563;
      }
      .meta-item i {
        color: #9ca3af;
      }
      .new-badge {
        position: absolute;
        top: -8px;
        left: -8px;
        background-color: #2563eb;
        color: white;
        font-size: 0.7rem;
        font-weight: bold;
        padding: 2px 6px;
        border-radius: 9999px;
        transform: rotate(-15deg);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        z-index: 10;
      }
      .stat-card {
        background-color: white;
        padding: 1.5rem;
        border-radius: 0.75rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        transition: all 0.2s ease;
        cursor: pointer;
      }
      .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
      }
      .details-section {
        display: none;
        font-size: 0.8rem;
        color: #6b7280;
        background-color: #f9fafb;
        padding: 0.75rem;
        margin-top: 0.5rem;
        border-radius: 4px;
        white-space: pre-wrap;
        border-left: 3px solid;
      }
      .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Custom Toast Notification for copying link */
      #toast-notification {
        transition: transform 0.5s ease-in-out;
        z-index: 100;
      }
      #toast-notification.show {
        transform: translateX(0);
      }

      /* Print styles */
      @media print {
        body {
          background-image: none;
        }
        main {
          padding: 0;
        }
        .no-print,
        .sidebar,
        header,
        .modal,
        #connection-status,
        #toast-notification {
          display: none !important;
        }
        body * {
          visibility: hidden;
        }
        main,
        main * {
          visibility: visible;
        }
        #dashboardView,
        #agendaView,
        #kanbanView,
        #filteredKanbanView {
          display: block !important;
          position: absolute;
          left: 0;
          top: 0;
          width: 100%;
        }
        .kanban-board {
          flex-wrap: wrap;
          width: 100%;
          padding: 0;
          gap: 1rem;
        }
        .kanban-column {
          page-break-inside: avoid;
          box-shadow: none;
          border: 1px solid #ccc;
        }
        .main-content {
          overflow: visible;
        }
        .stat-card {
          box-shadow: none;
          border: 1px solid #ccc;
        }
      }
    </style>
  </head>
  <body>
    <div
      id="connection-status"
      class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-3 text-center sticky top-0 z-30 text-sm font-medium"
    >
      <i class="fa-solid fa-spinner fa-spin mr-2"></i>กำลังเชื่อมต่อฐานข้อมูล
      Real-time...
    </div>

    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar">
      <div class="p-4 flex justify-between items-center border-b">
        <h2 class="text-xl font-bold text-gray-800">เมนูนำทาง</h2>
        <button id="closeSidebarBtn" class="text-gray-500 hover:text-gray-800">
          <i class="fa-solid fa-times fa-lg"></i>
        </button>
      </div>
      <nav id="sidebarMenu" class="sidebar-menu flex-grow"></nav>
      <div class="p-4 border-t space-y-2 no-print">
        <button
          id="openTrashBtn"
          class="w-full text-left text-gray-600 hover:bg-red-50 hover:text-red-600 p-3 rounded-md transition-colors duration-200 flex items-center gap-3 font-medium"
        >
          <i class="fa-solid fa-trash-can fa-lg w-6 text-center"></i
          ><span>ถังขยะ</span>
        </button>
      </div>
    </aside>
    <div id="sidebarOverlay" class="sidebar-overlay"></div>

    <!-- Header -->
    <header
      class="bg-white shadow-md p-3 sm:p-4 flex justify-between items-center sticky top-0 z-20 no-print"
    >
      <div class="flex items-center gap-4">
        <button id="openSidebarBtn" class="text-gray-600 hover:text-blue-500">
          <i class="fa-solid fa-bars fa-xl"></i>
        </button>
        <h1 class="text-lg md:text-xl font-bold text-gray-800 hidden sm:block">
          ระบบจัดการงาน Real-time
        </h1>
      </div>
      <!-- Responsive Header Buttons -->
      <div class="flex items-center gap-2 sm:gap-4">
        <button
          id="shareBtn"
          title="แชร์บอร์ด"
          class="bg-green-500 hover:bg-green-600 text-white font-bold w-10 h-10 sm:h-auto sm:w-auto sm:px-4 sm:py-2 rounded-lg shadow-md transition-transform transform hover:scale-105 flex items-center justify-center sm:gap-2"
        >
          <i class="fa-solid fa-share-alt"></i>
          <span class="hidden sm:inline">แชร์บอร์ด</span>
        </button>
        <button
          id="importNotesBtn"
          title="นำเข้าอัจฉริยะ"
          class="bg-violet-500 hover:bg-violet-600 text-white font-bold w-10 h-10 sm:h-auto sm:w-auto sm:px-4 sm:py-2 rounded-lg shadow-md transition-transform transform hover:scale-105 flex items-center justify-center sm:gap-2"
        >
          <i class="fa-solid fa-wand-magic-sparkles"></i>
          <span class="hidden sm:inline">นำเข้าอัจฉริยะ</span>
        </button>
        <button
          id="addTaskBtn"
          title="เพิ่มงานใหม่"
          class="bg-blue-500 hover:bg-blue-600 text-white font-bold w-10 h-10 sm:h-auto sm:w-auto sm:px-4 sm:py-2 rounded-lg shadow-md transition-transform transform hover:scale-105 flex items-center justify-center sm:gap-2"
        >
          <i class="fa-solid fa-plus"></i>
          <span class="hidden sm:inline">เพิ่มงานใหม่</span>
        </button>
      </div>
    </header>

    <main>
      <!-- Dashboard View -->
      <div id="dashboardView">
        <div class="p-4 sm:p-6">
          <div
            class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-6"
          >
            <div class="stat-card" data-filter="pending">
              <h3 class="text-gray-500 font-medium">รอดำเนินการ</h3>
              <p id="pendingTasks" class="text-3xl font-bold text-gray-800">
                0
              </p>
            </div>
            <div class="stat-card" data-filter="in-progress">
              <h3 class="text-gray-500 font-medium">กำลังดำเนินการ</h3>
              <p id="inProgressTasks" class="text-3xl font-bold text-blue-500">
                0
              </p>
            </div>
            <div class="stat-card" data-filter="urgent">
              <h3 class="text-gray-500 font-medium">งานด่วน</h3>
              <p id="urgentTasks" class="text-3xl font-bold text-red-500">0</p>
            </div>
            <div class="stat-card" data-filter="completed">
              <h3 class="text-gray-500 font-medium">งานเสร็จแล้ว</h3>
              <p id="completedTasks" class="text-3xl font-bold text-green-500">
                0
              </p>
            </div>
          </div>
          <div class="bg-white p-4 sm:p-6 rounded-lg shadow-lg">
            <h2 class="text-xl font-bold mb-4 text-gray-700">
              สัดส่วนประเภทงาน
            </h2>
            <div class="max-w-xl mx-auto"><canvas id="taskChart"></canvas></div>
          </div>
        </div>
      </div>

      <!-- Agenda View -->
      <div id="agendaView" class="hidden p-4 sm:p-6 w-full">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
          <div class="bg-red-50 border border-red-200 rounded-lg p-4">
            <h2
              class="text-lg font-bold text-red-700 flex items-center gap-2 mb-3"
            >
              <i class="fa-solid fa-circle-exclamation"></i> งานที่เกินกำหนด
            </h2>
            <ul id="overdueList" class="space-y-2"></ul>
          </div>
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <h2
              class="text-lg font-bold text-blue-700 flex items-center gap-2 mb-3"
            >
              <i class="fa-solid fa-star"></i> วันนี้
            </h2>
            <h3
              class="text-md font-semibold text-blue-800/80 mb-2 border-b border-blue-200 pb-1"
            >
              ต้องเริ่มทำ
            </h3>
            <ul id="startTodayList" class="space-y-2 mb-4"></ul>
            <h3
              class="text-md font-semibold text-blue-800/80 mb-2 border-b border-blue-200 pb-1"
            >
              ครบกำหนด
            </h3>
            <ul id="dueTodayList" class="space-y-2"></ul>
          </div>
          <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
            <h2
              class="text-lg font-bold text-gray-700 flex items-center gap-2 mb-3"
            >
              <i class="fa-solid fa-arrow-right"></i> งานวันพรุ่งนี้
            </h2>
            <h3
              class="text-md font-semibold text-gray-800/80 mb-2 border-b border-gray-200 pb-1"
            >
              ต้องเริ่มทำ
            </h3>
            <ul id="startTomorrowList" class="space-y-2 mb-4"></ul>
            <h3
              class="text-md font-semibold text-gray-800/80 mb-2 border-b border-gray-200 pb-1"
            >
              ครบกำหนด
            </h3>
            <ul id="dueTomorrowList" class="space-y-2"></ul>
          </div>
        </div>
        <div class="bg-white p-4 rounded-lg shadow-md">
          <h2
            class="text-lg font-bold text-gray-700 flex items-center gap-2 mb-3"
          >
            <i class="fa-solid fa-calendar-week"></i> กำหนดการอื่นๆ
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <h3
                class="text-md font-semibold text-gray-800/90 mb-2 border-b pb-1"
              >
                ต้องเริ่มทำ
              </h3>
              <ul id="startUpcomingList" class="space-y-2"></ul>
            </div>
            <div>
              <h3
                class="text-md font-semibold text-gray-800/90 mb-2 border-b pb-1"
              >
                ครบกำหนด
              </h3>
              <ul id="dueUpcomingList" class="space-y-2"></ul>
            </div>
          </div>
        </div>
      </div>

      <!-- Kanban View -->
      <div id="kanbanView" class="hidden">
        <div class="main-content">
          <div id="kanbanBoard" class="kanban-board"></div>
          <div class="p-4 sm:p-6 self-start">
            <button
              id="addCategoryBtn"
              class="add-category-btn-kanban bg-white/80 hover:bg-white text-gray-600 font-semibold py-2 px-4 rounded-lg shadow-md h-20 border-2 border-dashed border-gray-300 hover:border-blue-500 transition-all duration-200 flex items-center justify-center gap-2"
              style="width: 320px"
            >
              <i class="fa-solid fa-plus"></i> เพิ่มประเภทงานใหม่
            </button>
          </div>
        </div>
      </div>

      <!-- Filtered Kanban View -->
      <div id="filteredKanbanView" class="hidden p-4 sm:p-6 w-full">
        <button
          id="backToDashboardBtn"
          class="mb-4 bg-white hover:bg-gray-100 text-gray-800 font-semibold py-2 px-4 border border-gray-300 rounded-lg shadow-sm flex items-center gap-2"
        >
          <i class="fa-solid fa-arrow-left"></i> กลับไปที่แดชบอร์ด
        </button>
        <div id="filteredKanbanContent"></div>
      </div>
    </main>

    <!-- Modals -->
    <!-- Task Form Modal -->
    <div
      id="taskModal"
      class="modal fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto py-12"
    >
      <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg mx-auto">
        <h2 class="text-xl font-bold mb-4" id="modalTitle">เพิ่มงานใหม่</h2>
        <form id="taskForm">
          <input type="hidden" id="editTaskIndices" />
          <div class="mb-4">
            <label
              for="taskContent"
              class="block text-gray-700 text-sm font-bold mb-2"
              >รายละเอียดงาน:</label
            >
            <textarea
              id="taskContent"
              rows="4"
              class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500"
              required
            ></textarea>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label
                for="taskAssigner"
                class="block text-gray-700 text-sm font-bold mb-2"
                >ผู้มอบหมาย:</label
              >
              <input
                type="text"
                id="taskAssigner"
                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="ระบุชื่อ..."
              />
            </div>
            <div>
              <label
                for="taskCoordinator"
                class="block text-gray-700 text-sm font-bold mb-2"
                >ผู้ประสานงาน:</label
              >
              <input
                type="text"
                id="taskCoordinator"
                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="ระบุชื่อ..."
              />
            </div>
          </div>
          <div class="mb-4">
            <div class="flex justify-between items-center mb-2">
              <label
                for="taskCategorySelect"
                class="block text-gray-700 text-sm font-bold"
                >เลือกประเภทโปรเจกต์:</label
              >
              <button
                type="button"
                id="addNewCategoryFromModalBtn"
                class="text-blue-500 hover:text-blue-700 text-sm font-semibold flex items-center gap-1"
              >
                <i class="fa-solid fa-plus"></i>สร้างใหม่
              </button>
            </div>
            <select
              id="taskCategorySelect"
              class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500"
            ></select>
          </div>
          <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2"
              >สถานะ:</label
            >
            <div class="grid grid-cols-3 gap-2" id="taskStatus">
              <label
                class="flex items-center justify-center p-2 border rounded-lg gap-2 cursor-pointer transition-all duration-200"
                ><input
                  type="radio"
                  name="status"
                  value="pending"
                  class="hidden peer"
                  checked
                />
                <i
                  class="fa-solid fa-hourglass-start text-gray-400 peer-checked:text-blue-600"
                ></i>
                <span class="peer-checked:text-blue-600 font-semibold"
                  >รอดำเนินการ</span
                ></label
              >
              <label
                class="flex items-center justify-center p-2 border rounded-lg gap-2 cursor-pointer transition-all duration-200"
                ><input
                  type="radio"
                  name="status"
                  value="in-progress"
                  class="hidden peer"
                />
                <i
                  class="fa-solid fa-person-digging text-gray-400 peer-checked:text-blue-600"
                ></i>
                <span class="peer-checked:text-blue-600 font-semibold"
                  >กำลังดำเนินการ</span
                ></label
              >
              <label
                class="flex items-center justify-center p-2 border rounded-lg gap-2 cursor-pointer transition-all duration-200"
                ><input
                  type="radio"
                  name="status"
                  value="completed"
                  class="hidden peer"
                />
                <i
                  class="fa-solid fa-check-circle text-gray-400 peer-checked:text-blue-600"
                ></i>
                <span class="peer-checked:text-blue-600 font-semibold"
                  >เสร็จสิ้น</span
                ></label
              >
            </div>
          </div>
          <div class="mb-4">
            <label class="flex items-center gap-2 cursor-pointer"
              ><input
                type="checkbox"
                id="isUrgentCheckbox"
                class="form-checkbox h-5 w-5"
              />
              <span class="font-bold text-red-500"
                ><i class="fa-solid fa-fire"></i> เป็นงานด่วน</span
              ></label
            >
          </div>
          <div class="flex items-center justify-end gap-3">
            <button
              type="button"
              id="cancelBtn"
              class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg"
            >
              ยกเลิก
            </button>
            <button
              type="submit"
              id="saveTaskBtn"
              class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2"
            >
              <i class="fa-solid fa-save"></i>บันทึก
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Task Detail Modal -->
    <div
      id="taskDetailModal"
      class="modal fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto py-12"
    >
      <div
        class="bg-white rounded-lg shadow-xl p-4 sm:p-6 w-full max-w-2xl mx-auto"
      >
        <div class="flex justify-between items-center mb-2">
          <h2 class="text-xl font-bold text-gray-800" id="detailModalTitle">
            รายละเอียดงาน
          </h2>
          <div class="flex items-center gap-2">
            <button
              id="printSummaryBtn"
              class="text-gray-500 hover:text-blue-600"
            >
              <i class="fa-solid fa-print"></i> พิมพ์/สรุป
            </button>
            <button
              id="deleteTaskFromDetailBtn"
              class="text-gray-500 hover:text-red-500 transition-colors duration-200 flex items-center gap-1 text-sm py-1 px-2 rounded-md hover:bg-red-50"
            >
              <i class="fa-solid fa-trash-can"></i> ลบงาน
            </button>
            <button
              id="closeDetailModalBtn"
              class="text-gray-500 hover:text-gray-800 text-3xl leading-none"
            >
              &times;
            </button>
          </div>
        </div>
        <div id="detailModalMeta" class="mb-4 border-b pb-4"></div>
        <div class="mb-4">
          <input type="hidden" id="detailTaskIndices" />
          <h3 class="text-lg font-semibold text-gray-700 mb-2">เช็คลิสต์</h3>
          <div id="checklistProgress" class="mb-2"></div>
          <ul
            id="checklistView"
            class="space-y-2 mb-3 max-h-40 overflow-y-auto pr-2"
          ></ul>
          <form id="addChecklistItemForm" class="space-y-2">
            <div>
              <div class="flex flex-wrap items-center gap-2">
                <input
                  type="text"
                  id="newChecklistItemText"
                  class="flex-grow shadow-sm border rounded py-1 px-2 text-sm"
                  placeholder="เพิ่มรายการใหม่..."
                  required
                />
                <input
                  type="date"
                  id="newChecklistItemStartDate"
                  class="shadow-sm border rounded py-1 px-2 text-sm"
                  required
                  title="วันที่ต้องเริ่มทำ"
                />
                <span class="text-gray-400">&rarr;</span>
                <input
                  type="date"
                  id="newChecklistItemDueDate"
                  class="shadow-sm border rounded py-1 px-2 text-sm"
                  required
                  title="วันที่ต้องเสร็จ"
                />
                <button
                  type="submit"
                  class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-3 rounded-md text-sm shrink-0"
                >
                  เพิ่ม
                </button>
              </div>
            </div>
            <div>
              <textarea
                id="newChecklistItemDescription"
                class="w-full shadow-sm border rounded py-1 px-2 text-sm"
                rows="2"
                placeholder="รายละเอียด (ถ้ามี)..."
              ></textarea>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Trash Modal -->
    <div
      id="trashModal"
      class="modal fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto py-12"
    >
      <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl mx-auto">
        <div class="flex justify-between items-center mb-4 border-b pb-3">
          <h2 class="text-xl font-bold text-gray-700 flex items-center gap-3">
            <i class="fa-solid fa-trash-can"></i>ถังขยะ
          </h2>
          <button
            id="closeTrashBtn"
            class="text-gray-500 hover:text-gray-800 text-3xl leading-none"
          >
            &times;
          </button>
        </div>
        <div id="trashList" class="max-h-[60vh] overflow-y-auto"></div>
      </div>
    </div>

    <!-- Other Modals -->
    <div
      id="newCategoryModal"
      class="modal fixed inset-0 bg-gray-600 bg-opacity-70 flex items-center justify-center hidden"
    >
      <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm mx-auto">
        <h2 class="text-xl font-bold mb-4">สร้างประเภทงานใหม่</h2>
        <form id="newCategoryForm">
          <div class="mb-4">
            <label
              for="newCategoryName"
              class="block text-gray-700 text-sm font-bold mb-2"
              >ชื่อประเภทงาน:</label
            >
            <input
              type="text"
              id="newCategoryName"
              class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500"
              required
            />
          </div>
          <div class="flex items-center justify-end gap-3">
            <button
              type="button"
              id="cancelNewCategoryBtn"
              class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg"
            >
              ยกเลิก
            </button>
            <button
              type="submit"
              class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg"
            >
              บันทึก
            </button>
          </div>
        </form>
      </div>
    </div>
    <div
      id="completeChecklistItemModal"
      class="modal fixed inset-0 bg-gray-600 bg-opacity-70 flex items-center justify-center hidden z-[60]"
    >
      <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg mx-auto">
        <h2 class="text-xl font-bold mb-2">ยืนยันการปิดรายการ</h2>
        <p id="completeChecklistItemName" class="text-gray-600 mb-4"></p>
        <form id="completeChecklistItemForm">
          <input type="hidden" id="completeChecklistItemIndices" />
          <div class="mb-4">
            <label
              for="completionDetailsText"
              class="block text-gray-700 text-sm font-bold mb-2"
              >รายละเอียดการปิดงาน:</label
            >
            <textarea
              id="completionDetailsText"
              rows="3"
              class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="อธิบายผลการดำเนินงาน..."
            ></textarea>
          </div>
          <div class="mb-4">
            <label
              for="completionDetailsAttachments"
              class="block text-gray-700 text-sm font-bold mb-2"
              >แนบไฟล์หลักฐาน (ถ้ามี):</label
            >
            <input
              type="file"
              id="completionDetailsAttachments"
              multiple
              class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer"
            />
          </div>
          <div class="flex items-center justify-end gap-3">
            <button
              type="button"
              id="cancelCompleteChecklistItemBtn"
              class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg"
            >
              ยกเลิก
            </button>
            <button
              type="submit"
              class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg"
            >
              ยืนยันการปิดงาน
            </button>
          </div>
        </form>
      </div>
    </div>
    <div
      id="updateItemModal"
      class="modal fixed inset-0 bg-gray-600 bg-opacity-70 flex items-center justify-center hidden z-[60]"
    >
      <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg mx-auto">
        <h2 class="text-xl font-bold mb-2">อัพเดตความคืบหน้า</h2>
        <p id="updateItemName" class="text-gray-600 mb-4"></p>
        <form id="updateItemForm">
          <input type="hidden" id="updateItemIndices" />
          <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2"
              >ประเภทการอัพเดต:</label
            >
            <div class="flex gap-4 p-2 bg-gray-50 rounded-lg">
              <label
                class="flex-1 flex items-center justify-center p-2 border rounded-lg gap-2 cursor-pointer transition-all duration-200 has-[:checked]:bg-blue-100 has-[:checked]:border-blue-400"
              >
                <input
                  type="radio"
                  name="updateType"
                  value="update"
                  class="hidden peer"
                  checked
                />
                <i
                  class="fa-solid fa-info-circle text-gray-400 peer-checked:text-blue-600"
                ></i>
                <span class="peer-checked:text-blue-600 font-semibold">
                  ความคืบหน้า</span
                >
              </label>
              <label
                class="flex-1 flex items-center justify-center p-2 border rounded-lg gap-2 cursor-pointer transition-all duration-200 has-[:checked]:bg-red-100 has-[:checked]:border-red-400"
              >
                <input
                  type="radio"
                  name="updateType"
                  value="issue"
                  class="hidden peer"
                />
                <i
                  class="fa-solid fa-triangle-exclamation text-gray-400 peer-checked:text-red-600"
                ></i>
                <span class="peer-checked:text-red-600 font-semibold">
                  แจ้งปัญหา</span
                >
              </label>
            </div>
          </div>
          <div class="mb-4">
            <label
              for="updateItemText"
              class="block text-gray-700 text-sm font-bold mb-2"
              >รายละเอียด:</label
            >
            <textarea
              id="updateItemText"
              rows="3"
              class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500"
              required
              placeholder="อธิบายความคืบหน้า หรือปัญหาที่พบ..."
            ></textarea>
          </div>
          <div class="mb-4">
            <label
              for="updateItemAttachments"
              class="block text-gray-700 text-sm font-bold mb-2"
              >แนบไฟล์ (ถ้ามี):</label
            >
            <input
              type="file"
              id="updateItemAttachments"
              multiple
              class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer"
            />
          </div>
          <div class="flex items-center justify-end gap-3">
            <button
              type="button"
              id="cancelUpdateItemBtn"
              class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg"
            >
              ยกเลิก
            </button>
            <button
              type="submit"
              class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg"
            >
              บันทึก
            </button>
          </div>
        </form>
      </div>
    </div>
    <div
      id="editChecklistItemModal"
      class="modal fixed inset-0 bg-gray-600 bg-opacity-70 flex items-center justify-center hidden z-[60]"
    >
      <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg mx-auto">
        <h2 class="text-xl font-bold mb-4">แก้ไขรายการเช็คลิสต์</h2>
        <form id="editChecklistItemForm">
          <input type="hidden" id="editChecklistItemIndices" />
          <div class="mb-4">
            <label
              for="editChecklistItemText"
              class="block text-gray-700 text-sm font-bold mb-2"
              >ชื่อรายการ:</label
            >
            <input
              type="text"
              id="editChecklistItemText"
              class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500"
              required
            />
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label
                for="editChecklistItemStartDate"
                class="block text-gray-700 text-sm font-bold mb-2"
                >วันที่ต้องเริ่มทำ:</label
              >
              <input
                type="date"
                id="editChecklistItemStartDate"
                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700"
                required
              />
            </div>
            <div>
              <label
                for="editChecklistItemDueDate"
                class="block text-gray-700 text-sm font-bold mb-2"
                >วันที่ต้องเสร็จ:</label
              >
              <input
                type="date"
                id="editChecklistItemDueDate"
                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700"
                required
              />
            </div>
          </div>
          <div class="mb-4">
            <label
              for="editChecklistItemDescription"
              class="block text-gray-700 text-sm font-bold mb-2"
              >รายละเอียด:</label
            >
            <textarea
              id="editChecklistItemDescription"
              rows="3"
              class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500"
            ></textarea>
          </div>
          <div class="flex items-center justify-end gap-3">
            <button
              type="button"
              id="cancelEditChecklistItemBtn"
              class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg"
            >
              ยกเลิก
            </button>
            <button
              type="submit"
              class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg"
            >
              บันทึก
            </button>
          </div>
        </form>
      </div>
    </div>
    <div
      id="summaryModal"
      class="modal fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto py-12 z-[60]"
    >
      <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-3xl mx-auto">
        <div id="print-area">
          <div class="border-b-2 pb-4 mb-4">
            <h2 class="text-2xl font-bold" id="summaryModalTitle">
              สรุปรายงานผลการดำเนินงาน
            </h2>
            <p class="text-gray-500" id="summaryTaskCategory"></p>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 text-center">
            <div id="summaryTimeToStart"></div>
            <div id="summaryActiveDuration"></div>
            <div id="summaryStatus"></div>
          </div>
          <div id="summaryContent" class="space-y-4"></div>
          <div class="mt-6">
            <h3 class="font-bold text-lg mb-2">บันทึกเพิ่มเติม</h3>
            <textarea
              id="summaryEditable"
              class="w-full h-40 shadow appearance-none border rounded py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500"
            ></textarea>
            <div class="mt-4">
              <label
                for="summaryAttachments"
                class="block text-gray-700 text-sm font-bold mb-2"
                >แนบไฟล์:</label
              >
              <input
                type="file"
                id="summaryAttachments"
                multiple
                class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer"
              />
              <div
                id="summaryAttachmentList"
                class="text-xs text-gray-500 mt-2"
              ></div>
            </div>
          </div>
        </div>
        <div class="flex items-center justify-end gap-3 mt-4 no-print">
          <button
            type="button"
            id="exportSummaryJsonBtn"
            class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2"
          >
            <i class="fa-solid fa-file-code"></i> Export JSON
          </button>
          <button
            type="button"
            id="exportSummaryCsvBtn"
            class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2"
          >
            <i class="fa-solid fa-file-csv"></i> Export CSV
          </button>
          <button
            type="button"
            id="printBtn"
            class="bg-gray-700 hover:bg-gray-800 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2"
          >
            <i class="fa-solid fa-print"></i> พิมพ์
          </button>
          <button
            type="button"
            id="cancelSummaryBtn"
            class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg"
          >
            ปิด
          </button>
        </div>
      </div>
    </div>
    <div
      id="printPreviewModal"
      class="modal fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto py-12 z-[70]"
    >
      <div
        class="bg-white rounded-lg shadow-xl w-full max-w-4xl mx-auto flex flex-col"
        style="height: 90vh"
      >
        <div class="p-4 border-b flex justify-between items-center no-print">
          <h2 class="text-xl font-bold text-gray-800">ตัวอย่างก่อนพิมพ์</h2>
          <button
            id="closePreviewBtn"
            class="text-gray-500 hover:text-gray-800 text-3xl leading-none"
          >
            &times;
          </button>
        </div>
        <div
          id="print-preview-area"
          class="p-6 flex-grow overflow-y-auto bg-gray-100"
        ></div>
        <div
          class="p-4 bg-gray-50 border-t flex items-center justify-end gap-3 no-print"
        >
          <button
            type="button"
            id="cancelPreviewBtn"
            class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg"
          >
            ยกเลิก
          </button>
          <button
            type="button"
            id="confirmPrintBtn"
            class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2"
          >
            <i class="fa-solid fa-print"></i> ยืนยันการพิมพ์
          </button>
        </div>
      </div>
    </div>
    <div
      id="notificationModal"
      class="modal fixed inset-0 bg-gray-600 bg-opacity-70 flex items-center justify-center hidden z-[70]"
    >
      <div
        class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4 text-center transform transition-all duration-300 scale-95 opacity-0"
      >
        <i
          class="fa-solid fa-bell text-yellow-400 text-5xl mb-4 animate-bounce"
        ></i>
        <h2 class="text-2xl font-bold mb-4">การแจ้งเตือนประจำวัน</h2>
        <div class="space-y-3 text-lg text-left px-4">
          <p>
            <i class="fa-solid fa-fire text-red-500 w-6 text-center"></i> คุณมี
            <strong id="notificationUrgentCount" class="text-red-500">0</strong>
            งานด่วนที่ต้องจัดการ
          </p>
          <p>
            <i
              class="fa-solid fa-play-circle text-blue-500 w-6 text-center"
            ></i>
            มี
            <strong id="notificationStartTodayCount" class="text-blue-500"
              >0</strong
            >
            งานที่ต้องเริ่มทำวันนี้
          </p>
          <p>
            <i
              class="fa-solid fa-calendar-check text-green-500 w-6 text-center"
            ></i>
            และมี
            <strong id="notificationDueTodayCount" class="text-green-500"
              >0</strong
            >
            งานที่ต้องเสร็จวันนี้
          </p>
        </div>
        <div
          class="flex flex-col sm:flex-row items-center justify-center gap-4 mt-6"
        >
          <button
            id="closeNotificationBtn"
            class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg w-full sm:w-auto"
          >
            ปิด
          </button>
          <button
            id="goToAgendaBtn"
            class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg flex items-center justify-center gap-2 w-full sm:w-auto"
          >
            <i class="fa-solid fa-calendar-day"></i> ไปที่ตารางงาน
          </button>
        </div>
      </div>
    </div>
    <div
      id="deleteCategoryModal"
      class="modal fixed inset-0 bg-gray-600 bg-opacity-70 flex items-center justify-center hidden z-50"
    >
      <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm mx-auto">
        <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
          <i class="fa-solid fa-triangle-exclamation text-red-500"></i>
          ยืนยันการลบ
        </h2>
        <p id="deleteCategoryMessage" class="text-gray-600 mb-6"></p>
        <form id="deleteCategoryForm">
          <input type="hidden" id="deleteCategoryIndex" />
          <div class="flex items-center justify-end gap-3">
            <button
              type="button"
              id="cancelDeleteCategoryBtn"
              class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg"
            >
              ยกเลิก
            </button>
            <button
              type="submit"
              id="confirmDeleteCategoryBtn"
              class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg"
            >
              ยืนยันการลบ
            </button>
          </div>
        </form>
      </div>
    </div>
    <div
      id="templateModal"
      class="modal fixed inset-0 bg-gray-600 bg-opacity-70 flex items-center justify-center hidden z-50"
    >
      <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg mx-auto">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold" id="templateModalTitle">
            จัดการเทมเพลตเช็คลิสต์
          </h2>
          <button
            id="closeTemplateModalBtn"
            class="text-gray-500 hover:text-gray-800 text-3xl leading-none"
          >
            &times;
          </button>
        </div>
        <form id="addTemplateItemForm" class="mb-4 flex gap-2">
          <input type="hidden" id="templateCategoryIndex" />
          <input
            type="text"
            id="newTemplateItemText"
            class="flex-grow shadow-sm border rounded py-2 px-3 text-sm"
            placeholder="เพิ่มรายการใหม่ในเทมเพลต..."
            required
          />
          <button
            type="submit"
            class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md text-sm shrink-0"
          >
            เพิ่ม
          </button>
        </form>
        <div
          id="templateList"
          class="max-h-64 overflow-y-auto space-y-2 p-1"
        ></div>
      </div>
    </div>
    <div
      id="importNotesModal"
      class="modal fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto py-12 z-[60]"
    >
      <div
        class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl mx-auto transform transition-all"
      >
        <div class="flex justify-between items-start mb-4">
          <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
            <i class="fa-solid fa-wand-magic-sparkles text-violet-500"></i>
            นำเข้าอัจฉริยะ
          </h2>
          <button
            id="closeImportModalBtn"
            class="text-gray-400 hover:text-gray-600"
          >
            &times;
          </button>
        </div>
        <div id="notes-input-view">
          <p class="text-gray-600 mb-4">
            วางโน้ตหรือข้อความที่ต้องการสร้างเป็นงานด้านล่างนี้ AI
            จะช่วยวิเคราะห์และแยกรายการเช็คลิสต์ให้คุณ
          </p>
          <form id="importNotesForm">
            <textarea
              id="notesInput"
              rows="10"
              class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-violet-400"
              placeholder="ตัวอย่าง: - ประชุมทีม RCOT วันที่ 7-9 ต.ค. - แจ้งเรื่อง Workshop ให้พี่ผึ้งภายใน 15 ก.ย. - ติดตามเรื่องลงทะเบียน - เตรียมบูธ TSVIR ส่งข้อมูลให้ SV และจัดของ..."
            ></textarea>
            <div class="mt-4 flex justify-end">
              <button
                type="submit"
                class="bg-violet-500 hover:bg-violet-600 text-white font-bold py-2 px-5 rounded-lg flex items-center gap-2"
              >
                <i class="fa-solid fa-brain"></i> ประมวลผล
              </button>
            </div>
          </form>
        </div>
        <div id="notes-loading-view" class="hidden text-center py-10">
          <div class="loader mx-auto"></div>
          <p class="mt-4 text-gray-600">AI กำลังวิเคราะห์ข้อมูลของคุณ...</p>
        </div>
        <div id="notes-review-view" class="hidden">
          <p class="text-gray-600 mb-4">
            นี่คืองานที่ AI สร้างจากโน้ตของคุณ
            โปรดตรวจสอบและเลือกโปรเจกต์สำหรับแต่ละงาน
          </p>
          <div
            id="ai-generated-tasks"
            class="space-y-4 max-h-[50vh] overflow-y-auto p-2 bg-gray-50 rounded-lg"
          ></div>
          <div class="mt-6 flex justify-end gap-3">
            <button
              id="cancelImportBtn"
              type="button"
              class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg"
            >
              ยกเลิก
            </button>
            <button
              id="confirmImportBtn"
              type="button"
              class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-5 rounded-lg flex items-center gap-2"
            >
              <i class="fa-solid fa-check-circle"></i> ยืนยันและเพิ่มงาน
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast Notification Area -->
    <div
      id="toast-notification"
      class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg transform translate-x-[150%]"
    >
      <!-- Message is injected here -->
    </div>

    <script type="module">
      // Import Firebase modules
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        signInWithCustomToken,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        onSnapshot,
        setDoc,
        setLogLevel,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // =========================================================================================
      // === FIREBASE & APP CONFIGURATION ========================================================
      // =========================================================================================
      const appId =
        typeof __app_id !== "undefined" ? __app_id : "default-app-id";
      const firebaseConfig = JSON.parse(
        typeof __firebase_config !== "undefined" ? __firebase_config : "null"
      ) || {
        // This is a fallback config. It's recommended to provide the config via __firebase_config.
        apiKey: "AIzaSy...",
        authDomain: "your-project-id.firebaseapp.com",
        projectId: "your-project-id",
        storageBucket: "your-project-id.appspot.com",
        messagingSenderId: "...",
        appId: "...",
      };

      const initialData = {
        categories: [
          { title: "งานทั่วไป", tasks: [], checklistTemplate: [] },
          { title: "งานติดตาม", tasks: [], checklistTemplate: [] },
          { title: "งานประชุม", tasks: [], checklistTemplate: [] },
        ],
        trash: [],
      };
      // =========================================================================================

      const COLORS = [
        "#3b82f6",
        "#f97316",
        "#8b5cf6",
        "#10b981",
        "#ef4444",
        "#14b8a6",
        "#6366f1",
        "#ec4899",
      ];

      // --- Element Selectors ---
      const kanbanBoard = document.getElementById("kanbanBoard");
      const taskModal = document.getElementById("taskModal");
      const trashModal = document.getElementById("trashModal");
      const newCategoryModal = document.getElementById("newCategoryModal");
      const completeChecklistItemModal = document.getElementById(
        "completeChecklistItemModal"
      );
      const updateItemModal = document.getElementById("updateItemModal");
      const editChecklistItemModal = document.getElementById(
        "editChecklistItemModal"
      );
      const summaryModal = document.getElementById("summaryModal");
      const addTaskBtn = document.getElementById("addTaskBtn");
      const addCategoryBtn = document.getElementById("addCategoryBtn");
      const addNewCategoryFromModalBtn = document.getElementById(
        "addNewCategoryFromModalBtn"
      );
      const cancelBtn = document.getElementById("cancelBtn");
      const openTrashBtn = document.getElementById("openTrashBtn");
      const closeTrashBtn = document.getElementById("closeTrashBtn");
      const trashList = document.getElementById("trashList");
      const taskForm = document.getElementById("taskForm");
      const newCategoryForm = document.getElementById("newCategoryForm");
      const newCategoryNameInput = document.getElementById("newCategoryName");
      const cancelNewCategoryBtn = document.getElementById(
        "cancelNewCategoryBtn"
      );
      const taskCategorySelect = document.getElementById("taskCategorySelect");
      const taskContentInput = document.getElementById("taskContent");
      const taskAssignerInput = document.getElementById("taskAssigner");
      const taskCoordinatorInput = document.getElementById("taskCoordinator");
      const isUrgentCheckbox = document.getElementById("isUrgentCheckbox");
      const modalTitle = document.getElementById("modalTitle");
      const editTaskIndicesInput = document.getElementById("editTaskIndices");
      const sidebar = document.getElementById("sidebar");
      const sidebarOverlay = document.getElementById("sidebarOverlay");
      const openSidebarBtn = document.getElementById("openSidebarBtn");
      const closeSidebarBtn = document.getElementById("closeSidebarBtn");
      const sidebarMenu = document.getElementById("sidebarMenu");
      const taskDetailModal = document.getElementById("taskDetailModal");
      const closeDetailModalBtn = document.getElementById(
        "closeDetailModalBtn"
      );
      const deleteTaskFromDetailBtn = document.getElementById(
        "deleteTaskFromDetailBtn"
      );
      const detailModalTitle = document.getElementById("detailModalTitle");
      const detailModalMeta = document.getElementById("detailModalMeta");
      const detailTaskIndicesInput =
        document.getElementById("detailTaskIndices");
      const dashboardView = document.getElementById("dashboardView");
      const kanbanView = document.getElementById("kanbanView");
      const agendaView = document.getElementById("agendaView");
      const addChecklistItemForm = document.getElementById(
        "addChecklistItemForm"
      );
      const completeChecklistItemForm = document.getElementById(
        "completeChecklistItemForm"
      );
      const cancelCompleteChecklistItemBtn = document.getElementById(
        "cancelCompleteChecklistItemBtn"
      );
      const updateItemForm = document.getElementById("updateItemForm");
      const cancelUpdateItemBtn = document.getElementById(
        "cancelUpdateItemBtn"
      );
      const editChecklistItemForm = document.getElementById(
        "editChecklistItemForm"
      );
      const cancelEditChecklistItemBtn = document.getElementById(
        "cancelEditChecklistItemBtn"
      );
      const printSummaryBtn = document.getElementById("printSummaryBtn");
      const cancelSummaryBtn = document.getElementById("cancelSummaryBtn");
      const printBtn = document.getElementById("printBtn");
      const notificationModal = document.getElementById("notificationModal");
      const closeNotificationBtn = document.getElementById(
        "closeNotificationBtn"
      );
      const goToAgendaBtn = document.getElementById("goToAgendaBtn");
      const filteredKanbanView = document.getElementById("filteredKanbanView");
      const backToDashboardBtn = document.getElementById("backToDashboardBtn");
      const printPreviewModal = document.getElementById("printPreviewModal");
      const confirmPrintBtn = document.getElementById("confirmPrintBtn");
      const cancelPreviewBtn = document.getElementById("cancelPreviewBtn");
      const closePreviewBtn = document.getElementById("closePreviewBtn");
      const deleteCategoryModal = document.getElementById(
        "deleteCategoryModal"
      );
      const deleteCategoryForm = document.getElementById("deleteCategoryForm");
      const cancelDeleteCategoryBtn = document.getElementById(
        "cancelDeleteCategoryBtn"
      );
      const templateModal = document.getElementById("templateModal");
      const addTemplateItemForm = document.getElementById(
        "addTemplateItemForm"
      );
      const closeTemplateModalBtn = document.getElementById(
        "closeTemplateModalBtn"
      );
      const importNotesBtn = document.getElementById("importNotesBtn");
      const importNotesModal = document.getElementById("importNotesModal");
      const closeImportModalBtn = document.getElementById(
        "closeImportModalBtn"
      );
      const importNotesForm = document.getElementById("importNotesForm");
      const cancelImportBtn = document.getElementById("cancelImportBtn");
      const confirmImportBtn = document.getElementById("confirmImportBtn");
      const exportSummaryJsonBtn = document.getElementById(
        "exportSummaryJsonBtn"
      );
      const exportSummaryCsvBtn = document.getElementById(
        "exportSummaryCsvBtn"
      );
      const shareBtn = document.getElementById("shareBtn");
      const connectionStatus = document.getElementById("connection-status");

      let data = {};
      let draggedItem = null;
      let taskChart = null;
      let currentTaskForSummary = null;
      let unsubscribe; // To hold the listener function for cleanup

      let db, auth;

      // --- Firebase Initialization and Data Handling ---
      let boardId = window.location.hash.substring(1);
      if (!boardId) {
        boardId =
          "board-" +
          Date.now().toString(36) +
          Math.random().toString(36).substring(2);
        history.replaceState(null, "", "#" + boardId);
      }

      try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        setLogLevel("debug");

        onAuthStateChanged(auth, (user) => {
          if (user) {
            // User is authenticated, now we can listen to data
            if (unsubscribe) unsubscribe(); // Detach any old listener
            listenToBoardData();
          } else {
            // No user, attempt to sign in
            signInUser();
          }
        });
      } catch (error) {
        console.error("Firebase Initialization Error:", error);
        connectionStatus.innerHTML = `<i class="fa-solid fa-triangle-exclamation mr-2"></i>การเชื่อมต่อล้มเหลว: กรุณาตรวจสอบ Firebase Config`;
        connectionStatus.classList.replace("bg-yellow-100", "bg-red-100");
        connectionStatus.classList.replace(
          "border-yellow-500",
          "border-red-500"
        );
        connectionStatus.classList.replace("text-yellow-700", "text-red-700");
      }

      async function signInUser() {
        try {
          if (
            typeof __initial_auth_token !== "undefined" &&
            __initial_auth_token
          ) {
            await signInWithCustomToken(auth, __initial_auth_token);
          } else {
            await signInAnonymously(auth);
          }
        } catch (error) {
          console.error("Authentication failed:", error);
          let errorMessage = "การเชื่อมต่อล้มเหลว: ไม่สามารถ Sign-in ได้";
          if (error.code) {
            switch (error.code) {
              case "auth/api-key-not-valid":
                errorMessage =
                  "การเชื่อมต่อล้มเหลว: API Key ไม่ถูกต้อง! กรุณาตรวจสอบค่า `firebaseConfig`";
                break;
              case "auth/admin-restricted-operation":
                errorMessage =
                  "การเชื่อมต่อล้มเหลว: กรุณาเปิดใช้งาน Anonymous sign-in ใน Firebase Console";
                break;
            }
          }
          connectionStatus.innerHTML = `<i class="fa-solid fa-triangle-exclamation mr-2"></i>${errorMessage}`;
          connectionStatus.classList.replace("bg-yellow-100", "bg-red-100");
          connectionStatus.classList.replace(
            "border-yellow-500",
            "border-red-500"
          );
          connectionStatus.classList.replace("text-yellow-700", "text-red-700");
        }
      }

      function listenToBoardData() {
        const boardRef = doc(
          db,
          "artifacts",
          appId,
          "public",
          "data",
          "boards",
          boardId
        );
        unsubscribe = onSnapshot(
          boardRef,
          (docSnap) => {
            if (docSnap.exists()) {
              data = docSnap.data().content;
            } else {
              console.log("No such board! Creating a new one in Firestore.");
              data = initialData;
              saveData(); // Create the initial document
            }
            renderAll();
            connectionStatus.innerHTML = `<i class="fa-solid fa-check-circle mr-2"></i>เชื่อมต่อ Real-time สำเร็จ! แชร์ลิงก์นี้เพื่อทำงานร่วมกัน`;
            connectionStatus.classList.replace("bg-yellow-100", "bg-green-100");
            connectionStatus.classList.replace(
              "border-yellow-500",
              "border-green-500"
            );
            connectionStatus.classList.replace(
              "text-yellow-700",
              "text-green-700"
            );
          },
          (error) => {
            console.error("Firestore listener error:", error);
            connectionStatus.innerHTML = `<i class="fa-solid fa-triangle-exclamation mr-2"></i>เกิดข้อผิดพลาด: ${error.message}`;
            connectionStatus.classList.replace("bg-yellow-100", "bg-red-100");
          }
        );
      }

      // MODIFIED: saveData now writes to Firestore using the correct path
      async function saveData() {
        if (!boardId || !auth.currentUser) {
          console.error("Board ID or user auth is not set. Cannot save data.");
          return;
        }
        try {
          const boardRef = doc(
            db,
            "artifacts",
            appId,
            "public",
            "data",
            "boards",
            boardId
          );
          await setDoc(boardRef, { content: data });
        } catch (error) {
          console.error("Error saving data to Firestore: ", error);
        }
      }

      // --- Core Rendering Functions ---
      function renderAll() {
        if (!data || !data.categories) {
          console.log("Data is not ready for rendering.");
          return;
        }
        renderBoard();
        renderDashboard();
        renderSidebarMenu();
        if (!agendaView.classList.contains("hidden")) {
          renderAgendaView();
        }
      }

      function showToast(message) {
        const toast = document.getElementById("toast-notification");
        toast.textContent = message;
        toast.classList.add("show");
        setTimeout(() => {
          toast.classList.remove("show");
        }, 3000);
      }

      // --- All other functions (renderDashboard, renderBoard, modals, etc.) remain largely the same, but are included below for completeness ---

      taskDetailModal.addEventListener("click", (e) => {
        const downloadBtn = e.target.closest(".download-attachment-btn");
        if (downloadBtn) {
          e.preventDefault();
          const url = downloadBtn.dataset.url;
          const name = downloadBtn.dataset.name;

          if (!url || !name) {
            console.error("Attachment URL or name is missing.");
            return;
          }

          const link = document.createElement("a");
          link.href = url;
          link.download = name;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }
      });

      function renderDashboard() {
        if (!data.categories) return;
        const labels = data.categories.map((cat) => cat.title);
        const taskCounts = data.categories.map(
          (cat) => (cat.tasks || []).length
        );
        const allTasks = data.categories.flatMap((c) => c.tasks || []);
        const allChecklistItems = data.categories
          .flatMap((c) => c.tasks || [])
          .flatMap((t) => t.checklist || [])
          .filter((i) => !i.completed);

        document.getElementById("pendingTasks").textContent = allTasks.filter(
          (t) => t.status === "pending"
        ).length;
        document.getElementById("inProgressTasks").textContent =
          allTasks.filter((t) => t.status === "in-progress").length;
        document.getElementById("urgentTasks").textContent =
          allChecklistItems.filter((t) => t.isUrgent).length;
        document.getElementById("completedTasks").textContent = allTasks.filter(
          (t) => t.status === "completed"
        ).length;

        const ctx = document.getElementById("taskChart").getContext("2d");
        if (taskChart) {
          taskChart.destroy();
        }
        taskChart = new Chart(ctx, {
          type: "pie",
          data: {
            labels: labels,
            datasets: [
              {
                label: "จำนวนงาน",
                data: taskCounts,
                backgroundColor: COLORS.slice(0, labels.length),
                borderColor: "#ffffff",
                borderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: "top" },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    let label = context.label || "";
                    if (label) {
                      label += ": ";
                    }
                    if (context.parsed !== null) {
                      label += context.parsed + " งาน";
                    }
                    return label;
                  },
                },
              },
            },
            onClick: (event, elements) => {
              if (elements.length > 0) {
                const chartElement = elements[0];
                const index = chartElement.index;
                const categoryId = `cat-${index}`;

                switchView("kanban");

                setTimeout(() => {
                  const targetElement = document.getElementById(categoryId);
                  if (targetElement) {
                    targetElement.scrollIntoView({
                      behavior: "smooth",
                      block: "nearest",
                      inline: "start",
                    });
                  }
                }, 100);
              }
            },
          },
        });
      }

      function renderBoard() {
        kanbanBoard.innerHTML = "";
        if (!data.categories) return;
        data.categories.forEach((category, catIndex) => {
          const color = COLORS[catIndex % COLORS.length];
          const columnEl = document.createElement("div");
          columnEl.className = "kanban-column";
          columnEl.dataset.catIndex = catIndex;
          columnEl.id = `cat-${catIndex}`;
          columnEl.style.borderTopColor = color;

          const activeTasks = (category.tasks || []).filter(
            (t) => t.status !== "completed"
          );
          const completedTasks = (category.tasks || []).filter(
            (t) => t.status === "completed"
          );

          columnEl.innerHTML = `
                    <div class="column-header" style="color: ${color};">
                        <span class="font-bold text-lg">${category.title}</span>
                        <div class="flex items-center gap-2">
                            <button class="manage-template-btn text-gray-400 hover:text-blue-500 text-sm" title="จัดการเทมเพลต"><i class="fa-solid fa-list-alt"></i></button>
                            <button class="delete-category-btn text-gray-400 hover:text-red-500 text-sm" title="ลบประเภทงาน"><i class="fa-solid fa-trash-can"></i></button>
                            <span class="task-count">${activeTasks.length}</span>
                        </div>
                    </div>
                    <div class="task-list"></div>
                    <div class="completed-section-header mt-2 p-2 border-t cursor-pointer text-sm font-semibold text-gray-500 hover:text-gray-800">
                       <i class="fa-solid fa-chevron-down mr-2 transition-transform duration-200"></i> งานที่เสร็จแล้ว (${completedTasks.length})
                    </div>
                    <div class="completed-task-list task-list hidden"></div>
                `;

          const taskList = columnEl.querySelector(".task-list");
          activeTasks.forEach((task, taskIndex) => {
            const originalIndex = (category.tasks || []).findIndex(
              (t) => t === task
            );
            const taskCard = createTaskCard(
              task,
              catIndex,
              originalIndex,
              color
            );
            taskList.appendChild(taskCard);
          });

          const completedTaskList = columnEl.querySelector(
            ".completed-task-list"
          );
          completedTasks.forEach((task, taskIndex) => {
            const originalIndex = (category.tasks || []).findIndex(
              (t) => t === task
            );
            const taskCard = createTaskCard(
              task,
              catIndex,
              originalIndex,
              color
            );
            completedTaskList.appendChild(taskCard);
          });

          const completedHeader = columnEl.querySelector(
            ".completed-section-header"
          );
          completedHeader.addEventListener("click", () => {
            completedTaskList.classList.toggle("hidden");
            completedHeader.querySelector("i").classList.toggle("rotate-180");
          });

          kanbanBoard.appendChild(columnEl);
        });
        addDragAndDropListeners();
      }

      function createTaskCard(task, catIndex, taskIndex, color) {
        const taskCard = document.createElement("div");
        taskCard.className = "task-card";
        taskCard.classList.add(`status-${task.status}`);
        taskCard.style.borderLeftColor = color;
        if (task.isNew && task.status === "pending") {
          const newBadge = document.createElement("span");
          newBadge.className = "new-badge";
          newBadge.textContent = "ใหม่";
          taskCard.appendChild(newBadge);
        }
        taskCard.addEventListener("click", (e) => {
          if (!e.target.closest(".task-action-btn")) {
            openDetailModal(catIndex, taskIndex);
          }
        });
        const contentEl = document.createElement("div");
        contentEl.className = "task-card-content";
        contentEl.draggable = true;
        contentEl.dataset.catIndex = catIndex;
        contentEl.dataset.taskIndex = taskIndex;
        contentEl.innerHTML = formatTaskContent(task.content);

        const checklist = task.checklist || [];
        if (checklist.length > 0) {
          const checklistProgressEl = document.createElement("div");
          checklistProgressEl.className = "mt-3";
          const completed = checklist.filter((i) => i.completed).length;
          const total = checklist.length;
          const percentage = total > 0 ? (completed / total) * 100 : 0;
          checklistProgressEl.innerHTML = `
                    <div class="flex justify-between items-center mb-1 text-xs text-gray-500">
                        <span class="flex items-center gap-1"><i class="fa-solid fa-list-check"></i> เช็คลิสต์</span>
                        <span>${completed}/${total}</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-1.5">
                        <div class="bg-blue-500 h-1.5 rounded-full" style="width: ${percentage}%"></div>
                    </div>
                `;
          contentEl.appendChild(checklistProgressEl);
        }

        const metaEl = document.createElement("div");
        metaEl.className = "task-meta";
        metaEl.innerHTML = `<div class="meta-item"><i class="fa-solid fa-user-pen"></i> <span>${
          task.assigner || "N/A"
        }</span></div><div class="meta-item"><i class="fa-solid fa-user-group"></i> <span>${
          task.coordinator || "N/A"
        }</span></div>`;
        const footerEl = document.createElement("div");
        footerEl.className = "task-footer";
        let statusBadge = "";
        if (task.status === "pending")
          statusBadge = `<span class="text-xs font-semibold px-2 py-1 bg-gray-200 text-gray-800 rounded-full">รอดำเนินการ</span>`;
        if (task.status === "in-progress")
          statusBadge = `<span class="text-xs font-semibold px-2 py-1 bg-blue-200 text-blue-800 rounded-full">กำลังดำเนินการ</span>`;
        if (task.status === "completed")
          statusBadge = `<span class="text-xs font-semibold px-2 py-1 bg-green-200 text-green-800 rounded-full">เสร็จสิ้น</span>`;

        const hasUrgentChecklistItem = (task.checklist || []).some(
          (item) => item.isUrgent && !item.completed
        );
        const isTaskDisplayUrgent = task.isUrgent || hasUrgentChecklistItem;
        const urgentIcon = isTaskDisplayUrgent
          ? `<i class="fa-solid fa-fire text-red-500" title="มีงานด่วนในเช็คลิสต์"></i>`
          : "";

        const issueCount = (task.checklist || []).reduce(
          (acc, item) =>
            acc + (item.updates || []).filter((u) => u.type === "issue").length,
          0
        );

        const attachmentCount = (task.checklist || []).reduce((acc, item) => {
          let itemAttachments = 0;
          if (item.completionDetails && item.completionDetails.attachments) {
            itemAttachments += item.completionDetails.attachments.length;
          }
          if (item.updates) {
            itemAttachments += item.updates.reduce(
              (updAcc, upd) =>
                updAcc + (upd.attachments ? upd.attachments.length : 0),
              0
            );
          }
          return acc + itemAttachments;
        }, 0);

        const updatesCount = (task.checklist || []).reduce(
          (acc, item) => acc + (item.updates ? item.updates.length : 0),
          0
        );

        footerEl.innerHTML = `
                <div class="flex items-center gap-2"> ${statusBadge} ${urgentIcon} </div>
                <div class="flex items-center gap-3 ml-auto">
                    ${
                      issueCount > 0
                        ? `<span class="text-red-500 font-bold" title="มีปัญหา"><i class="fa-solid fa-triangle-exclamation"></i> ${issueCount}</span>`
                        : ""
                    }
                    ${
                      attachmentCount > 0
                        ? `<span title="มีไฟล์แนบ"><i class="fa-solid fa-paperclip"></i> ${attachmentCount}</span>`
                        : ""
                    }
                    <span title="จำนวนอัพเดต"><i class="fa-regular fa-comment-dots"></i> ${updatesCount}</span>
                </div>`;
        const actionsEl = document.createElement("div");
        actionsEl.className = "task-actions";

        let actionButtonsHTML = "";
        if (task.status === "completed") {
          actionButtonsHTML += `<button class="task-action-btn reopen" title="เปิดงานอีกครั้ง"><i class="fa-solid fa-arrow-rotate-left"></i></button>`;
        }
        actionButtonsHTML += `<button class="task-action-btn edit" title="แก้ไข"><i class="fa-solid fa-pencil"></i></button>`;
        actionButtonsHTML += `<button class="task-action-btn delete" title="ลบ"><i class="fa-solid fa-trash-can"></i></button>`;
        actionsEl.innerHTML = actionButtonsHTML;

        const reopenBtn = actionsEl.querySelector(".reopen");
        if (reopenBtn) {
          reopenBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            reopenTask(catIndex, taskIndex);
          });
        }

        actionsEl.querySelector(".edit").addEventListener("click", (e) => {
          e.stopPropagation();
          openModalForEdit(catIndex, taskIndex);
        });
        actionsEl.querySelector(".delete").addEventListener("click", (e) => {
          e.stopPropagation();
          deleteTask(catIndex, taskIndex);
        });

        taskCard.appendChild(actionsEl);
        taskCard.appendChild(contentEl);
        taskCard.appendChild(metaEl);
        taskCard.appendChild(footerEl);
        return taskCard;
      }

      function reopenTask(catIndex, taskIndex) {
        const task = data.categories[catIndex].tasks[taskIndex];
        task.status = "in-progress";
        delete task.completedAt;
        saveData();
      }

      function deleteTask(catIndex, taskIndex) {
        const taskToDelete = data.categories[catIndex].tasks.splice(
          taskIndex,
          1
        )[0];
        if (!taskToDelete) {
          console.error(
            "Delete failed: task not found at index",
            taskIndex,
            "in category",
            catIndex
          );
          return;
        }
        taskToDelete.originalCategoryIndex = catIndex;
        if (!data.trash) data.trash = [];
        data.trash.push(taskToDelete);
        saveData();
      }

      function populateCategorySelect() {
        taskCategorySelect.innerHTML = "";
        if (!data.categories) return;
        data.categories.forEach((category, catIndex) => {
          const option = document.createElement("option");
          option.value = catIndex;
          option.textContent = category.title;
          taskCategorySelect.appendChild(option);
        });
      }

      function openModalForEdit(catIndex, taskIndex) {
        taskForm.reset();
        modalTitle.textContent = "แก้ไขงาน";
        populateCategorySelect();
        const task = data.categories[catIndex].tasks[taskIndex];
        taskContentInput.value = task.content;
        taskAssignerInput.value = task.assigner || "";
        taskCoordinatorInput.value = task.coordinator || "";
        taskCategorySelect.value = catIndex;
        isUrgentCheckbox.checked = task.isUrgent;
        editTaskIndicesInput.value = `${catIndex},${taskIndex}`;
        taskForm.querySelector(
          `input[name="status"][value="${task.status}"]`
        ).checked = true;

        const allChecklistItemsCompleted = (task.checklist || []).every(
          (item) => item.completed
        );
        const completedRadio = taskForm.querySelector(
          'input[name="status"][value="completed"]'
        );
        const completedLabel = completedRadio.closest("label");

        if (!allChecklistItemsCompleted && (task.checklist || []).length > 0) {
          completedRadio.disabled = true;
          completedLabel.classList.add("opacity-50", "cursor-not-allowed");
          completedLabel.title =
            'ต้องทำรายการในเช็คลิสต์ให้เสร็จทั้งหมดก่อน จึงจะเปลี่ยนสถานะเป็น "เสร็จสิ้น" ได้';
        } else {
          completedRadio.disabled = false;
          completedLabel.classList.remove("opacity-50", "cursor-not-allowed");
          completedLabel.title = "";
        }

        taskModal.classList.remove("hidden");
      }

      function openModalForAdd() {
        taskForm.reset();
        modalTitle.textContent = "เพิ่มงานใหม่";
        editTaskIndicesInput.value = "";
        populateCategorySelect();
        const completedRadio = taskForm.querySelector(
          'input[name="status"][value="completed"]'
        );
        const completedLabel = completedRadio.closest("label");
        completedRadio.disabled = false;
        completedLabel.classList.remove("opacity-50", "cursor-not-allowed");
        completedLabel.title = "";

        taskModal.classList.remove("hidden");
      }

      function openDetailModal(catIndex, taskIndex) {
        const task = data.categories[catIndex].tasks[taskIndex];
        if (task.isNew) {
          task.isNew = false;
          saveData();
        }
        detailModalTitle.innerHTML = formatTaskContent(task.content);
        detailModalMeta.innerHTML = `<div class="task-meta !grid-cols-2 text-sm"><div class="meta-item"><i class="fa-solid fa-user-pen"></i> <div><strong>ผู้มอบหมาย:</strong> ${
          task.assigner || "N/A"
        }</div></div><div class="meta-item"><i class="fa-solid fa-user-group"></i> <div><strong>ผู้ประสานงาน:</strong> ${
          task.coordinator || "N/A"
        }</div></div></div>`;
        detailTaskIndicesInput.value = `${catIndex},${taskIndex}`;
        renderChecklist(task, catIndex, taskIndex);
        addChecklistItemForm.reset();
        taskDetailModal.classList.remove("hidden");
      }

      taskForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const content = taskContentInput.value.trim();
        const assigner = taskAssignerInput.value.trim();
        const coordinator = taskCoordinatorInput.value.trim();
        const catIndex = taskCategorySelect.value;
        const status = taskForm.querySelector(
          'input[name="status"]:checked'
        ).value;
        const isUrgent = isUrgentCheckbox.checked;
        const editIndices = editTaskIndicesInput.value;
        if (!content) return;
        if (editIndices) {
          const [origCatIndex, taskIndex] = editIndices.split(",").map(Number);
          const task = data.categories[origCatIndex].tasks[taskIndex];
          task.content = content;
          task.assigner = assigner;
          task.coordinator = coordinator;
          task.status = status;
          task.isUrgent = isUrgent;
          if (origCatIndex != catIndex) {
            const movedTask = data.categories[origCatIndex].tasks.splice(
              taskIndex,
              1
            )[0];
            data.categories[catIndex].tasks.push(movedTask);
          }
        } else {
          const newTask = {
            content,
            assigner,
            coordinator,
            status,
            isUrgent,
            history: [],
            isNew: true,
            checklist: [],
            createdAt: new Date().toISOString(),
          };
          const template = data.categories[catIndex].checklistTemplate;
          if (template && template.length > 0) {
            newTask.checklist = template.map((item) => ({
              text: item.text,
              description: item.description || "",
              completed: false,
              updates: [],
              isUrgent: false,
              startDate: "",
              dueDate: "",
            }));
          }
          if (status === "in-progress" || status === "completed") {
            newTask.startedAt = new Date().toISOString();
          }
          if (status === "completed") {
            newTask.completedAt = new Date().toISOString();
          }
          data.categories[catIndex].tasks.push(newTask);
        }
        saveData();
        closeModal();
      });

      function closeModal() {
        const allModals = document.querySelectorAll(".modal");
        allModals.forEach((modal) => modal.classList.add("hidden"));
      }

      function renderSidebarMenu() {
        let menuHTML = `
                <div id="main-nav">
                    <div class="sidebar-menu-header">เมนูหลัก</div>
                    <a href="#" class="view-switch-link active" data-view="dashboard"><i class="fa-solid fa-chart-pie w-6"></i>แดชบอร์ด</a>
                    <a href="#" class="view-switch-link" data-view="agenda"><i class="fa-solid fa-calendar-day w-6"></i>ตารางงาน</a>
                    <a href="#" class="view-switch-link" data-view="kanban"><i class="fa-solid fa-list-check w-6"></i>บอร์ดจัดการงาน</a>
                </div>
                <div>
                    <div class="sidebar-menu-header">ประเภทโปรเจกต์</div>
            `;
        if (data && data.categories) {
          data.categories.forEach((cat, index) => {
            menuHTML += `<a href="#" class="sidebar-link" data-target-id="cat-${index}"><i class="fa-solid fa-folder w-6"></i> ${cat.title}</a>`;
          });
        }
        menuHTML += `</div>`;
        sidebarMenu.innerHTML = menuHTML;

        addSidebarLinkListeners();
        addViewSwitchLinkListeners();
      }

      function addViewSwitchLinkListeners() {
        document.querySelectorAll(".view-switch-link").forEach((link) => {
          link.addEventListener("click", (e) => {
            e.preventDefault();
            const view = e.currentTarget.dataset.view;
            switchView(view);
            closeSidebar();
          });
        });
      }

      function switchView(view) {
        document.getElementById("dashboardView").classList.add("hidden");
        document.getElementById("agendaView").classList.add("hidden");
        document.getElementById("kanbanView").classList.add("hidden");
        document.getElementById("filteredKanbanView").classList.add("hidden");

        const targetView = document.getElementById(`${view}View`);
        if (targetView) {
          targetView.classList.remove("hidden");
        }

        document
          .querySelectorAll(".view-switch-link")
          .forEach((link) => link.classList.remove("active"));
        const newActiveLink = document.querySelector(
          `.view-switch-link[data-view="${view}"]`
        );
        if (newActiveLink) {
          newActiveLink.classList.add("active");
        }

        if (view === "agenda") {
          renderAgendaView();
        } else if (view === "dashboard") {
          renderDashboard();
        }
      }

      addCategoryBtn.addEventListener("click", () => {
        newCategoryModal.classList.remove("hidden");
        newCategoryNameInput.focus();
      });

      addNewCategoryFromModalBtn.addEventListener("click", () => {
        newCategoryModal.classList.remove("hidden");
        newCategoryNameInput.focus();
      });

      newCategoryForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const categoryName = newCategoryNameInput.value.trim();
        if (categoryName) {
          data.categories.push({
            title: categoryName,
            tasks: [],
            checklistTemplate: [],
          });
          saveData();
          if (!taskModal.classList.contains("hidden")) {
            populateCategorySelect();
            taskCategorySelect.value = data.categories.length - 1;
          }
          newCategoryModal.classList.add("hidden");
          newCategoryForm.reset();
        }
      });

      cancelNewCategoryBtn.addEventListener("click", () => {
        newCategoryModal.classList.add("hidden");
        newCategoryForm.reset();
      });

      function renderTrashList() {
        trashList.innerHTML = "";
        if (!data.trash || data.trash.length === 0) {
          trashList.innerHTML = `<p class="text-center text-gray-500 py-8">ถังขยะว่างเปล่า</p>`;
          return;
        }
        data.trash.forEach((task, index) => {
          const item = document.createElement("div");
          item.className =
            "flex items-center justify-between p-3 border-b hover:bg-gray-50";
          item.innerHTML = `
                    <div class="flex-grow pr-4">
                        <p class="font-medium">${task.content}</p>
                        <p class="text-sm text-gray-500">ประเภทเดิม: ${
                          data.categories[task.originalCategoryIndex]?.title ||
                          "ไม่ระบุ"
                        }</p>
                    </div>
                    <div class="flex-shrink-0 flex gap-2">
                        <button data-index="${index}" class="restore-btn text-blue-500 hover:text-blue-700 font-semibold flex items-center gap-2 py-1 px-2 rounded-md hover:bg-blue-100 transition-colors"><i class="fa-solid fa-trash-arrow-up"></i> กู้คืน</button>
                        <button data-index="${index}" class="perm-delete-btn text-red-500 hover:text-red-700 font-semibold flex items-center gap-2 py-1 px-2 rounded-md hover:bg-red-100 transition-colors"><i class="fa-solid fa-eraser"></i> ลบถาวร</button>
                    </div>
                `;
          trashList.appendChild(item);
        });
      }

      trashList.addEventListener("click", (e) => {
        const restoreBtn = e.target.closest(".restore-btn");
        const deleteBtn = e.target.closest(".perm-delete-btn");
        if (restoreBtn) {
          const index = parseInt(restoreBtn.dataset.index);
          const taskToRestore = data.trash.splice(index, 1)[0];
          const originalCategoryIndex = taskToRestore.originalCategoryIndex;
          delete taskToRestore.originalCategoryIndex;
          if (data.categories[originalCategoryIndex]) {
            data.categories[originalCategoryIndex].tasks.push(taskToRestore);
          } else {
            data.categories[0].tasks.push(taskToRestore);
          }
          saveData();
          renderTrashList();
        }
        if (deleteBtn) {
          const index = parseInt(deleteBtn.dataset.index);
          data.trash.splice(index, 1);
          saveData();
          renderTrashList();
        }
      });

      openTrashBtn.addEventListener("click", () => {
        renderTrashList();
        trashModal.classList.remove("hidden");
      });
      closeTrashBtn.addEventListener("click", closeModal);

      function createAttachmentsHTML(attachments) {
        if (!attachments || attachments.length === 0) return "";

        let html =
          '<ul class="attachment-list !pt-2 !mt-2 grid grid-cols-2 sm:grid-cols-3 gap-2">';
        attachments.forEach((file) => {
          if (file.type && file.type.startsWith("image/")) {
            html += `
                        <li class="attachment-item">
                            <a href="#" class="download-attachment-btn block group relative" data-url="${file.url}" data-name="${file.name}">
                                <img src="${file.url}" alt="${file.name}" class="rounded-md w-full h-auto object-cover aspect-square">
                                <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-50 transition-all flex flex-col items-center justify-center text-white opacity-0 group-hover:opacity-100 rounded-md p-2 text-center">
                                     <i class="fa-solid fa-download text-lg"></i>
                                     <span class="text-xs mt-1 break-all">${file.name}</span>
                                </div>
                            </a>
                        </li>`;
          } else {
            html += `
                        <li class="attachment-item col-span-2 sm:col-span-3 bg-gray-100 p-2 rounded-md">
                            <a href="#" class="download-attachment-btn flex items-center gap-2" data-url="${file.url}" data-name="${file.name}" title="${file.name}">
                                <i class="fa-solid fa-file"></i> <span>${file.name}</span>
                            </a>
                        </li>`;
          }
        });
        html += "</ul>";
        return html;
      }

      function renderChecklist(task, catIndex, taskIndex) {
        const checklistView = document.getElementById("checklistView");
        const checklistProgress = document.getElementById("checklistProgress");
        checklistView.innerHTML = "";
        const checklistData = task.checklist || [];

        if (checklistData.length === 0) {
          checklistProgress.innerHTML = "";
          return;
        }

        const completed = checklistData.filter((i) => i.completed).length;
        const total = checklistData.length;
        const percentage = total > 0 ? (completed / total) * 100 : 0;

        checklistProgress.innerHTML = `
                <div class="flex justify-between items-center mb-1 text-sm">
                    <span class="font-semibold">${Math.round(
                      percentage
                    )}%</span>
                    <span>${completed}/${total}</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: ${percentage}%"></div>
                </div>`;

        checklistData.forEach((item, index) => {
          const li = document.createElement("li");
          li.className = "bg-gray-50 p-2 rounded-md";
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const isOverdue =
            item.dueDate && !item.completed && new Date(item.dueDate) < today;
          const issueCount = (item.updates || []).filter(
            (u) => u.type === "issue"
          ).length;

          const dateDisplay =
            item.startDate && item.dueDate
              ? `${item.startDate} &rarr; ${item.dueDate}`
              : item.dueDate || "N/A";

          li.innerHTML = `
                    <div class="flex items-start gap-3">
                        <input type="checkbox" ${
                          item.completed ? "checked" : ""
                        } class="form-checkbox h-5 w-5 rounded text-blue-500 focus:ring-blue-500 shrink-0 mt-1">
                        <div class="flex-grow">
                            <span class="cursor-pointer ${
                              item.isUrgent ? "text-red-700 font-semibold" : ""
                            }">
                                ${item.text}
                                ${
                                  item.description
                                    ? '<i class="fa-solid fa-circle-info text-gray-400 ml-1" title="มีรายละเอียด"></i>'
                                    : ""
                                }
                                ${
                                  item.completionDetails
                                    ? '<i class="fa-solid fa-receipt text-green-600 ml-1" title="มีรายละเอียดการปิดงาน"></i>'
                                    : ""
                                }
                                ${
                                  issueCount > 0
                                    ? `<i class="fa-solid fa-triangle-exclamation text-red-500 ml-1" title="${issueCount} ปัญหา"></i>`
                                    : ""
                                }
                            </span>
                        </div>
                         <div class="flex-shrink-0 flex items-center gap-2">
                             <span class="text-xs ${
                               isOverdue
                                 ? "font-bold text-red-500"
                                 : "text-gray-500"
                             }">${dateDisplay}</span>
                         </div>
                        <div class="flex-shrink-0 flex items-center">
                            <button class="edit-item-btn text-gray-400 hover:text-blue-500 w-6 h-6 flex items-center justify-center" title="แก้ไขรายการ"><i class="fa-solid fa-pencil"></i></button>
                            <button class="toggle-urgent-btn text-gray-400 hover:text-red-500 w-6 h-6 flex items-center justify-center ${
                              item.isUrgent ? "text-red-500" : ""
                            }" title="ตั้งเป็นงานด่วน"><i class="fa-solid fa-fire"></i></button>
                            ${
                              !item.completed
                                ? `<button class="add-update-btn text-gray-400 hover:text-blue-500 w-6 h-6 flex items-center justify-center" title="อัพเดตงาน"><i class="fa-solid fa-comment-dots"></i></button>`
                                : ""
                            }
                            <button class="delete-item-btn text-gray-400 hover:text-red-500 w-6 h-6 flex items-center justify-center" title="ลบรายการ">&times;</button>
                        </div>
                    </div>
                    <div class="details-section ml-8 border-l-gray-300 description-details">${
                      item.description || ""
                    }</div>
                    <div class="details-section ml-8 border-l-gray-400 updates-container"></div>
                `;

          const descriptionEl = li.querySelector(".description-details");
          const updatesContainerEl = li.querySelector(".updates-container");

          if (!item.description) {
            descriptionEl.style.display = "none";
          }

          let allUpdates = [...(item.updates || [])];
          if (item.completed && item.completionDetails) {
            allUpdates.push({
              type: "complete",
              text: item.completionDetails.text,
              attachments: item.completionDetails.attachments,
              timestamp: item.completionDetails.timestamp,
              editHistory: item.completionDetails.editHistory,
            });
          }

          if (allUpdates.length === 0) {
            updatesContainerEl.style.display = "none";
          } else {
            updatesContainerEl.innerHTML = `<p class="font-semibold mb-2">ประวัติความเคลื่อนไหว:</p>`;
            let sortedUpdates = allUpdates
              .map((u) => ({ ...u, date: parseThaiDateString(u.timestamp) }))
              .filter((u) => u.date)
              .sort((a, b) => a.date - b.date);

            sortedUpdates.forEach((update) => {
              const attachmentsHTML = createAttachmentsHTML(update.attachments);
              const isIssue = update.type === "issue";
              const isComplete = update.type === "complete";

              let icon, color, prefix, contentHTML;

              if (isIssue) {
                icon = "fa-triangle-exclamation text-red-500";
                prefix = "แจ้งปัญหาเมื่อ";
                contentHTML = `<p>${update.text}</p>`;
              } else if (isComplete) {
                icon = "fa-check-circle text-green-500";
                prefix = "ปิดงานเมื่อ";
                contentHTML = `<p class="font-semibold">ผลการดำเนินงาน:</p><p>${
                  update.text || "ไม่มีรายละเอียด"
                }</p>`;

                if (update.editHistory && update.editHistory.length > 0) {
                  contentHTML +=
                    '<div class="mt-2 pt-2 border-t border-gray-200"><p class="font-semibold text-xs mb-1">ประวัติการแก้ไข:</p><ul class="space-y-1 text-xs">';
                  update.editHistory.forEach((edit) => {
                    contentHTML += `<li class="text-gray-500">${edit.timestamp}: ${edit.reason}</li>`;
                  });
                  contentHTML += "</ul></div>";
                }
              } else {
                icon = "fa-info-circle text-blue-500";
                prefix = "อัพเดตเมื่อ";
                contentHTML = `<p>${update.text}</p>`;
              }

              const updateItemEl = document.createElement("div");
              updateItemEl.className =
                "pb-2 mb-2 border-b border-gray-200 last:border-b-0 last:pb-0 last:mb-0 relative pl-5";
              updateItemEl.innerHTML = `
                             <i class="fa-solid ${icon} absolute left-0 top-1"></i>
                             ${contentHTML}
                             ${attachmentsHTML}
                             <p class="text-xs text-gray-400 mt-2">${prefix}: ${update.timestamp}</p>
                         `;
              updatesContainerEl.appendChild(updateItemEl);
            });
          }

          li.querySelector("div.flex-grow > span").addEventListener(
            "click",
            () => {
              const isDescVisible = descriptionEl.style.display === "block";
              const isUpdateVisible =
                updatesContainerEl.style.display === "block";
              descriptionEl.style.display = isDescVisible
                ? "none"
                : item.description
                ? "block"
                : "none";
              updatesContainerEl.style.display = isUpdateVisible
                ? "none"
                : allUpdates && allUpdates.length > 0
                ? "block"
                : "none";
            }
          );

          li.querySelector('input[type="checkbox"]').addEventListener(
            "change",
            (e) => {
              e.preventDefault();
              if (e.target.checked) {
                openCompleteChecklistItemModal(catIndex, taskIndex, index);
              } else {
                item.completed = false;
                delete item.completionDetails;
                if (task.status === "completed") {
                  task.status = "in-progress";
                  delete task.completedAt; // Remove completed timestamp
                }
                saveData();
              }
            }
          );

          li.querySelector(".edit-item-btn").addEventListener("click", () => {
            openEditChecklistItemModal(catIndex, taskIndex, index);
          });

          li.querySelector(".toggle-urgent-btn").addEventListener(
            "click",
            () => {
              item.isUrgent = !item.isUrgent;
              saveData();
            }
          );

          const addUpdateBtn = li.querySelector(".add-update-btn");
          if (addUpdateBtn) {
            addUpdateBtn.addEventListener("click", () => {
              openUpdateItemModal(catIndex, taskIndex, index);
            });
          }

          const deleteBtn = li.querySelector(".delete-item-btn");
          if (deleteBtn) {
            deleteBtn.addEventListener("click", () => {
              checklistData.splice(index, 1);
              saveData();
            });
          }

          checklistView.appendChild(li);
        });
      }

      function openCompleteChecklistItemModal(catIndex, taskIndex, itemIndex) {
        const item =
          data.categories[catIndex].tasks[taskIndex].checklist[itemIndex];
        document.getElementById("completeChecklistItemName").textContent =
          item.text;
        document.getElementById(
          "completeChecklistItemIndices"
        ).value = `${catIndex},${taskIndex},${itemIndex}`;
        completeChecklistItemModal.classList.remove("hidden");
        completeChecklistItemForm.reset();
      }

      cancelCompleteChecklistItemBtn.addEventListener("click", () => {
        closeModal();
        const [catIndex, taskIndex, itemIndex] = document
          .getElementById("completeChecklistItemIndices")
          .value.split(",")
          .map(Number);
        const task = data.categories[catIndex].tasks[taskIndex];
        renderChecklist(task, catIndex, taskIndex);
      });

      completeChecklistItemForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const text = document
          .getElementById("completionDetailsText")
          .value.trim();
        const files = document.getElementById(
          "completionDetailsAttachments"
        ).files;
        const [catIndex, taskIndex, itemIndex] = document
          .getElementById("completeChecklistItemIndices")
          .value.split(",")
          .map(Number);

        const task = data.categories[catIndex].tasks[taskIndex];
        const item = task.checklist[itemIndex];

        if (task.status === "pending") {
          task.status = "in-progress";
          if (!task.startedAt) task.startedAt = new Date().toISOString();
        }

        const fileReadPromises = Array.from(files).map((file) => {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () =>
              resolve({ name: file.name, type: file.type, url: reader.result });
            reader.onerror = (error) => reject(error);
            reader.readAsDataURL(file);
          });
        });
        const attachments = await Promise.all(fileReadPromises);

        item.completed = true;
        item.completionDetails = {
          text: text,
          attachments: attachments,
          timestamp: new Date().toLocaleString("th-TH", {
            day: "2-digit",
            month: "2-digit",
            year: "numeric",
            hour: "2-digit",
            minute: "2-digit",
          }),
        };

        const allChecklistItemsCompleted = task.checklist.every(
          (ci) => ci.completed
        );
        if (allChecklistItemsCompleted) {
          task.status = "completed";
          if (!task.completedAt) task.completedAt = new Date().toISOString();
        }

        saveData();
        closeModal();
      });

      function openEditChecklistItemModal(catIndex, taskIndex, itemIndex) {
        const item =
          data.categories[catIndex].tasks[taskIndex].checklist[itemIndex];
        document.getElementById(
          "editChecklistItemIndices"
        ).value = `${catIndex},${taskIndex},${itemIndex}`;
        document.getElementById("editChecklistItemText").value = item.text;
        document.getElementById("editChecklistItemDescription").value =
          item.description || "";
        document.getElementById("editChecklistItemStartDate").value =
          item.startDate || "";
        document.getElementById("editChecklistItemDueDate").value =
          item.dueDate || "";
        editChecklistItemModal.classList.remove("hidden");
      }

      cancelEditChecklistItemBtn.addEventListener("click", closeModal);

      editChecklistItemForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const [catIndex, taskIndex, itemIndex] = document
          .getElementById("editChecklistItemIndices")
          .value.split(",")
          .map(Number);
        const newText = document
          .getElementById("editChecklistItemText")
          .value.trim();
        const newDescription = document
          .getElementById("editChecklistItemDescription")
          .value.trim();
        const newStartDate = document.getElementById(
          "editChecklistItemStartDate"
        ).value;
        const newDueDate = document.getElementById(
          "editChecklistItemDueDate"
        ).value;

        if (newText) {
          const task = data.categories[catIndex].tasks[taskIndex];
          const item = task.checklist[itemIndex];
          item.text = newText;
          item.description = newDescription;
          item.startDate = newStartDate;
          item.dueDate = newDueDate;

          saveData();
          closeModal();
        }
      });

      function openUpdateItemModal(catIndex, taskIndex, itemIndex) {
        const item =
          data.categories[catIndex].tasks[taskIndex].checklist[itemIndex];
        document.getElementById("updateItemName").textContent = item.text;
        document.getElementById(
          "updateItemIndices"
        ).value = `${catIndex},${taskIndex},${itemIndex}`;
        updateItemModal.classList.remove("hidden");
        updateItemForm.reset();
      }

      cancelUpdateItemBtn.addEventListener("click", closeModal);

      updateItemForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const text = document.getElementById("updateItemText").value.trim();
        const files = document.getElementById("updateItemAttachments").files;
        const updateType = document.querySelector(
          'input[name="updateType"]:checked'
        ).value;
        const [catIndex, taskIndex, itemIndex] = document
          .getElementById("updateItemIndices")
          .value.split(",")
          .map(Number);

        const task = data.categories[catIndex].tasks[taskIndex];
        const item = task.checklist[itemIndex];

        const fileReadPromises = Array.from(files).map((file) => {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () =>
              resolve({ name: file.name, type: file.type, url: reader.result });
            reader.onerror = (error) => reject(error);
            reader.readAsDataURL(file);
          });
        });
        const attachments = await Promise.all(fileReadPromises);

        if (!item.updates) item.updates = [];
        item.updates.push({
          type: updateType,
          text: text,
          attachments: attachments,
          timestamp: new Date().toLocaleString("th-TH", {
            day: "2-digit",
            month: "2-digit",
            year: "numeric",
            hour: "2-digit",
            minute: "2-digit",
          }),
        });

        if (task.status === "pending") {
          task.status = "in-progress";
          if (!task.startedAt) {
            task.startedAt = new Date().toISOString();
          }
        }
        saveData();
        closeModal();
      });

      addChecklistItemForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const textInput = document.getElementById("newChecklistItemText");
        const startDateInput = document.getElementById(
          "newChecklistItemStartDate"
        );
        const dueDateInput = document.getElementById("newChecklistItemDueDate");
        const descriptionInput = document.getElementById(
          "newChecklistItemDescription"
        );

        const text = textInput.value.trim();
        const startDate = startDateInput.value;
        const dueDate = dueDateInput.value;
        const description = descriptionInput.value.trim();

        if (text && startDate && dueDate) {
          const [catIndex, taskIndex] = detailTaskIndicesInput.value
            .split(",")
            .map(Number);
          const task = data.categories[catIndex].tasks[taskIndex];
          if (!task.checklist) task.checklist = [];
          task.checklist.push({
            text,
            completed: false,
            startDate,
            dueDate,
            description,
            updates: [],
            isUrgent: false,
          });
          saveData();
          addChecklistItemForm.reset();
        }
      });

      function renderAgendaView() {
        const overdueList = document.getElementById("overdueList");
        const startTodayList = document.getElementById("startTodayList");
        const dueTodayList = document.getElementById("dueTodayList");
        const startTomorrowList = document.getElementById("startTomorrowList");
        const dueTomorrowList = document.getElementById("dueTomorrowList");
        const startUpcomingList = document.getElementById("startUpcomingList");
        const dueUpcomingList = document.getElementById("dueUpcomingList");

        let allChecklistItems = [];
        if (data && data.categories) {
          data.categories.forEach((cat, catIndex) => {
            (cat.tasks || []).forEach((task, taskIndex) => {
              (task.checklist || []).forEach((item, itemIndex) => {
                if (!item.completed) {
                  allChecklistItems.push({
                    ...item,
                    catIndex,
                    taskIndex,
                    taskContent: task.content,
                  });
                }
              });
            });
          });
        }

        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);

        const overdueItems = allChecklistItems.filter(
          (i) => i.dueDate && new Date(i.dueDate) < today
        );

        const startTodayItems = allChecklistItems.filter(
          (i) =>
            i.startDate &&
            new Date(i.startDate).toDateString() === today.toDateString()
        );
        const dueTodayItems = allChecklistItems.filter(
          (i) =>
            i.dueDate &&
            new Date(i.dueDate).toDateString() === today.toDateString()
        );

        const startTomorrowItems = allChecklistItems.filter(
          (i) =>
            i.startDate &&
            new Date(i.startDate).toDateString() === tomorrow.toDateString()
        );
        const dueTomorrowItems = allChecklistItems.filter(
          (i) =>
            i.dueDate &&
            new Date(i.dueDate).toDateString() === tomorrow.toDateString()
        );

        const startUpcomingItems = allChecklistItems.filter(
          (i) => i.startDate && new Date(i.startDate) > tomorrow
        );
        const dueUpcomingItems = allChecklistItems.filter(
          (i) => i.dueDate && new Date(i.dueDate) > tomorrow
        );

        const createAgendaItem = (item) => {
          const li = document.createElement("li");
          li.className =
            "bg-white p-3 rounded-md shadow-sm cursor-pointer hover:bg-gray-50 transition-shadow";
          const isItemOverdue = item.dueDate && new Date(item.dueDate) < today;

          li.innerHTML = `
                     <div class="flex justify-between items-start">
                         <div class="flex-grow pr-2">
                             <p class="font-semibold">${
                               item.isUrgent
                                 ? '<i class="fa-solid fa-fire text-red-500 mr-1"></i>'
                                 : ""
                             }${item.text}</p>
                             <p class="text-sm text-gray-500 truncate">${
                               data.categories[item.catIndex].title
                             }</p>
                         </div>
                         ${
                           isItemOverdue
                             ? `<span class="text-xs font-bold text-red-500 bg-red-100 px-2 py-1 rounded-full shrink-0">เกินกำหนด</span>`
                             : ""
                         }
                     </div>
                     <div class="text-xs text-gray-600 mt-2 pt-2 border-t flex justify-between items-center gap-2">
                         <span><strong>เริ่ม:</strong> <span class="font-medium text-gray-800">${
                           item.startDate || "N/A"
                         }</span></span>
                         <span><strong>เสร็จ:</strong> <span class="font-medium ${
                           isItemOverdue ? "text-red-600" : "text-gray-800"
                         }">${item.dueDate || "N/A"}</span></span>
                     </div>
                 `;
          li.addEventListener("click", () =>
            openDetailModal(item.catIndex, item.taskIndex)
          );
          return li;
        };

        const populateAgendaList = (
          items,
          listEl,
          sortByDateType,
          emptyMessage
        ) => {
          listEl.innerHTML = "";
          if (items.length === 0) {
            listEl.innerHTML = `<li class="text-center text-sm text-gray-500 py-2">${emptyMessage}</li>`;
            return;
          }
          const sortByUrgencyAndDate = (a, b) => {
            if (a.isUrgent && !b.isUrgent) return -1;
            if (!a.isUrgent && b.isUrgent) return 1;
            if (a[sortByDateType] && b[sortByDateType])
              return new Date(a[sortByDateType]) - new Date(b[sortByDateType]);
            return 0;
          };

          items.sort(sortByUrgencyAndDate).forEach((item) => {
            listEl.appendChild(createAgendaItem(item));
          });
        };

        populateAgendaList(
          overdueItems,
          overdueList,
          "dueDate",
          "ไม่มีงานที่เกินกำหนด"
        );
        populateAgendaList(
          startTodayItems,
          startTodayList,
          "startDate",
          "ไม่มีงานที่ต้องเริ่มวันนี้"
        );
        populateAgendaList(
          dueTodayItems,
          dueTodayList,
          "dueDate",
          "ไม่มีงานที่ครบกำหนดวันนี้"
        );
        populateAgendaList(
          startTomorrowItems,
          startTomorrowList,
          "startDate",
          "ไม่มีงานที่ต้องเริ่มพรุ่งนี้"
        );
        populateAgendaList(
          dueTomorrowItems,
          dueTomorrowList,
          "dueDate",
          "ไม่มีงานที่ครบกำหนดพรุ่งนี้"
        );
        populateAgendaList(
          startUpcomingItems,
          startUpcomingList,
          "startDate",
          "ไม่มีงานที่ต้องเริ่ม"
        );
        populateAgendaList(
          dueUpcomingItems,
          dueUpcomingList,
          "dueDate",
          "ไม่มีงานที่ครบกำหนด"
        );
      }

      // --- Helper & Utility Functions ---
      function formatTaskContent(content) {
        return content
          .replace(
            /\((\d{1,2}[\.\/]\d{1,2}[\.\/]\d{2,4})\)/g,
            '(<span class="highlight-date">$1</span>)'
          )
          .replace(
            /\b(\d{1,3}(,\d{3})*(\.\d+)?)\b/g,
            '<span class="highlight-money">$1</span>'
          )
          .replace(
            /(ติดตาม|รีมายด์|ค้าง|รอ)/g,
            '<span class="highlight-keyword">$1</span>'
          );
      }
      function openSidebar() {
        sidebar.classList.add("open");
        sidebarOverlay.classList.add("open");
      }
      function closeSidebar() {
        sidebar.classList.remove("open");
        sidebarOverlay.classList.remove("open");
      }
      function addSidebarLinkListeners() {
        document.querySelectorAll(".sidebar-link").forEach((link) => {
          link.addEventListener("click", (e) => {
            e.preventDefault();
            const targetId = e.currentTarget.dataset.targetId;
            const targetElement = document.getElementById(targetId);
            switchView("kanban");
            if (targetElement) {
              const container = document.querySelector(".main-content");
              const containerRect = container.getBoundingClientRect();
              const targetRect = targetElement.getBoundingClientRect();
              container.scrollLeft += targetRect.left - containerRect.left - 24;
            }
            closeSidebar();
          });
        });
      }
      function addDragAndDropListeners() {
        const taskCards = document.querySelectorAll(".task-card-content");
        const taskLists = document.querySelectorAll(".task-list");
        taskCards.forEach((card) => {
          card.addEventListener("dragstart", (e) => {
            draggedItem = e.target
              .closest(".task-card")
              .querySelector(".task-card-content");
            setTimeout(
              () => e.target.closest(".task-card").classList.add("dragging"),
              0
            );
          });
          card.addEventListener("dragend", () => {
            document
              .querySelector(".task-card.dragging")
              ?.classList.remove("dragging");
            draggedItem = null;
          });
        });
        taskLists.forEach((list) => {
          list.addEventListener("dragover", (e) => {
            e.preventDefault();
          });
          list.addEventListener("drop", (e) => {
            e.preventDefault();
            const targetColumnEl = e.target.closest(".kanban-column");
            if (!targetColumnEl || !draggedItem) return;
            const fromCatIndex = parseInt(draggedItem.dataset.catIndex);
            const fromTaskIndex = parseInt(draggedItem.dataset.taskIndex);
            const toCatIndex = parseInt(targetColumnEl.dataset.catIndex);
            const taskToMove =
              data.categories[fromCatIndex].tasks[fromTaskIndex];
            data.categories[fromCatIndex].tasks.splice(fromTaskIndex, 1);
            const afterElement = getDragAfterElement(
              targetColumnEl.querySelector(
                ".task-list:not(.completed-task-list)"
              ),
              e.clientY
            );
            if (afterElement) {
              const toTaskIndex = parseInt(
                afterElement.querySelector(".task-card-content").dataset
                  .taskIndex
              );
              data.categories[toCatIndex].tasks.splice(
                toTaskIndex,
                0,
                taskToMove
              );
            } else {
              data.categories[toCatIndex].tasks.push(taskToMove);
            }
            saveData();
          });
        });
      }
      function getDragAfterElement(container, y) {
        const draggableElements = [
          ...container.querySelectorAll(".task-card:not(.dragging)"),
        ];
        return draggableElements.reduce(
          (closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
              return { offset: offset, element: child };
            } else {
              return closest;
            }
          },
          { offset: Number.NEGATIVE_INFINITY }
        ).element;
      }

      // --- Summary & Print Functions ---
      printSummaryBtn.addEventListener("click", () => {
        const [catIndex, taskIndex] = detailTaskIndicesInput.value
          .split(",")
          .map(Number);
        const task = data.categories[catIndex].tasks[taskIndex];
        openSummaryModal(task, catIndex);
      });
      cancelSummaryBtn.addEventListener("click", closeModal);

      printBtn.addEventListener("click", () => {
        const previewArea = document.getElementById("print-preview-area");

        const originalPrintArea = document
          .getElementById("print-area")
          .cloneNode(true);

        originalPrintArea.querySelector("#summaryEditable").style.display =
          "none";
        const extraInputsSection = originalPrintArea.querySelector(".mt-6");
        if (extraInputsSection) extraInputsSection.style.display = "none";

        previewArea.innerHTML = "";
        previewArea.appendChild(originalPrintArea);

        const summaryNotes = document.getElementById("summaryEditable").value;

        let additionalContentHTML = "";
        if (summaryNotes.trim() !== "") {
          additionalContentHTML += `<div class="mt-6"><h3 class="font-bold text-lg mb-2 border-t pt-4">บันทึกเพิ่มเติม:</h3><p class="whitespace-pre-wrap">${summaryNotes}</p></div>`;
        }

        const attachmentPreviewsContainer = document.getElementById(
          "summaryAttachmentList"
        );
        if (attachmentPreviewsContainer.innerHTML.trim() !== "") {
          additionalContentHTML += `<div class="mt-6"><h3 class="font-bold text-lg mb-2 ${
            summaryNotes.trim() === "" ? "" : "border-t pt-4"
          }">ไฟล์แนบเพิ่มเติม:</h3>${
            attachmentPreviewsContainer.innerHTML
          }</div>`;
        }

        previewArea.querySelector("#print-area").innerHTML +=
          additionalContentHTML;

        printPreviewModal.classList.remove("hidden");
      });

      confirmPrintBtn.addEventListener("click", () => {
        const printContent =
          document.getElementById("print-preview-area").innerHTML;
        const printWindow = window.open("", "_blank");

        printWindow.document.write(`
                <html>
                    <head>
                        <title>พิมพ์สรุปงาน</title>
                        <script src="https://cdn.tailwindcss.com"><\/script>
                        <link rel="preconnect" href="https://fonts.googleapis.com">
                        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
                        <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
                        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
                        <style>
                            body { font-family: 'Kanit', sans-serif; padding: 1.5rem; }
                            .attachment-item a { color: #3b82f6 !important; text-decoration: none !important; }
                            .attachment-item img { border: 1px solid #eee; }
                        </style>
                    </head>
                    <body>
                        ${printContent}
                    </body>
                </html>
            `);

        printWindow.document.close();

        printWindow.onload = function () {
          setTimeout(function () {
            printWindow.focus();
            printWindow.print();
            printWindow.close();
          }, 250);
        };
      });

      cancelPreviewBtn.addEventListener("click", () => {
        printPreviewModal.classList.add("hidden");
      });
      closePreviewBtn.addEventListener("click", () => {
        printPreviewModal.classList.add("hidden");
      });

      const summaryAttachmentsInput =
        document.getElementById("summaryAttachments");
      const summaryAttachmentList = document.getElementById(
        "summaryAttachmentList"
      );
      summaryAttachmentsInput.addEventListener("change", () => {
        summaryAttachmentList.innerHTML = "";
        const files = summaryAttachmentsInput.files;
        if (files.length > 0) {
          summaryAttachmentList.innerHTML =
            '<div class="grid grid-cols-2 sm:grid-cols-4 gap-2 mt-2"></div>';
          const grid = summaryAttachmentList.querySelector(".grid");

          Array.from(files).forEach((file) => {
            const reader = new FileReader();
            reader.onload = (e) => {
              const previewWrapper = document.createElement("div");
              if (file.type.startsWith("image/")) {
                previewWrapper.innerHTML = `
                                <div class="relative group aspect-square">
                                    <img src="${e.target.result}" alt="${file.name}" class="rounded-md w-full h-full object-cover">
                                    <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-60 text-white text-xs p-1 rounded-b-md truncate" title="${file.name}">${file.name}</div>
                                </div>
                            `;
              } else {
                previewWrapper.innerHTML = `
                                <div class="relative group aspect-square bg-gray-100 rounded-md flex flex-col items-center justify-center p-2 border text-center">
                                    <i class="fa-solid fa-file-lines text-3xl text-gray-400"></i>
                                    <span class="text-xs mt-2 break-all" title="${file.name}">${file.name}</span>
                                </div>
                            `;
              }
              grid.appendChild(previewWrapper);
            };
            reader.readAsDataURL(file);
          });
        }
      });

      function parseThaiDateString(dateString) {
        if (!dateString) return null;
        const cleanedString = dateString.replace(",", "").trim();
        const parts = cleanedString.split(" ");

        const dateParts = parts[0].split("/");
        if (dateParts.length < 3) return null;

        let timeParts = [0, 0];
        if (parts.length > 1 && parts[1].includes(":")) {
          timeParts = parts[1].split(":");
        }

        const day = parseInt(dateParts[0], 10);
        const month = parseInt(dateParts[1], 10) - 1;
        const year = parseInt(dateParts[2], 10);
        const hour = parseInt(timeParts[0], 10) || 0;
        const minute = parseInt(timeParts[1], 10) || 0;

        const finalYear = year > 2500 ? year - 543 : year;

        const dateObj = new Date(finalYear, month, day, hour, minute);
        return isNaN(dateObj) ? null : dateObj;
      }

      function formatDuration(ms) {
        if (!ms || ms < 0) return "N/A";
        let seconds = Math.floor(ms / 1000);
        let minutes = Math.floor(seconds / 60);
        let hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);
        hours = hours % 24;
        minutes = minutes % 60;
        let durationString = "";
        if (days > 0) durationString += `${days} วัน `;
        if (hours > 0) durationString += `${hours} ชั่วโมง `;
        if (minutes > 0) durationString += `${minutes} นาที`;
        return durationString.trim() || "น้อยกว่า 1 นาที";
      }

      function openSummaryModal(task, catIndex) {
        currentTaskForSummary = {
          ...task,
          categoryTitle: data.categories[catIndex].title,
        };

        document.getElementById(
          "summaryModalTitle"
        ).textContent = `สรุปรายงาน: ${task.content}`;
        document.getElementById("summaryTaskCategory").innerHTML = `
                <span class="text-gray-500">ประเภท: ${
                  data.categories[catIndex].title
                }</span>
                <div class="flex flex-col sm:flex-row gap-x-4 gap-y-1 text-sm mt-1">
                    <span><i class="fa-solid fa-user-pen mr-1 text-gray-400"></i><strong>ผู้มอบหมาย:</strong> ${
                      task.assigner || "N/A"
                    }</span>
                    <span><i class="fa-solid fa-user-group mr-1 text-gray-400"></i><strong>ผู้ประสานงาน:</strong> ${
                      task.coordinator || "N/A"
                    }</span>
                </div>
            `;

        const timeToStart = task.startedAt
          ? new Date(task.startedAt) - new Date(task.createdAt)
          : null;
        const activeDuration =
          task.completedAt && task.startedAt
            ? new Date(task.completedAt) - new Date(task.startedAt)
            : null;

        document.getElementById(
          "summaryTimeToStart"
        ).innerHTML = `<p class="font-semibold text-sm text-gray-500">เวลารอเริ่ม</p><p class="font-bold text-lg">${formatDuration(
          timeToStart
        )}</p>`;
        document.getElementById(
          "summaryActiveDuration"
        ).innerHTML = `<p class="font-semibold text-sm text-gray-500">เวลาดำเนินการ</p><p class="font-bold text-lg">${formatDuration(
          activeDuration
        )}</p>`;

        let statusBadge = "";
        if (task.status === "pending")
          statusBadge = `<span class="font-semibold text-base px-3 py-1 bg-gray-200 text-gray-800 rounded-full">รอดำเนินการ</span>`;
        if (task.status === "in-progress")
          statusBadge = `<span class="font-semibold text-base px-3 py-1 bg-blue-200 text-blue-800 rounded-full">กำลังดำเนินการ</span>`;
        if (task.status === "completed")
          statusBadge = `<span class="font-semibold text-base px-3 py-1 bg-green-200 text-green-800 rounded-full">เสร็จสิ้น</span>`;
        document.getElementById(
          "summaryStatus"
        ).innerHTML = `<p class="font-semibold text-sm text-gray-500">สถานะ</p>${statusBadge}`;

        let summaryContentHTML = "";
        let summaryText = `บทสรุปสำหรับผู้บริหาร\n=========================\n`;
        summaryText += `งาน: ${task.content}\nสถานะ: ${task.status}\n`;
        if (activeDuration)
          summaryText += `ใช้เวลาดำเนินการทั้งหมด: ${formatDuration(
            activeDuration
          )}\n\n`;

        const checklist = task.checklist || [];

        if (checklist.length > 0) {
          summaryContentHTML +=
            '<h3 class="font-bold text-lg mb-2 border-b pb-2">รายละเอียดการดำเนินงานตามเช็คลิสต์</h3><div class="space-y-4">';
          summaryText +=
            "รายละเอียดการดำเนินงานตามเช็คลิสต์\n--------------------------------------\n";

          checklist.forEach((item) => {
            const statusIcon = item.completed
              ? '<i class="fa-solid fa-check-circle text-green-500"></i>'
              : '<i class="fa-regular fa-circle text-gray-400"></i>';

            summaryContentHTML += `<div class="p-3 bg-gray-50 rounded-lg border">`;
            summaryContentHTML += `<p class="font-semibold flex items-center gap-2">${statusIcon} ${item.text}</p>`;
            summaryText += `[${item.completed ? "x" : " "}] ${item.text}\n`;

            if (item.description) {
              summaryContentHTML += `<p class="text-sm text-gray-600 pl-6 border-l-2 border-gray-200 ml-2 my-1 italic">"${item.description}"</p>`;
              summaryText += `  รายละเอียด: ${item.description}\n`;
            }

            let combinedUpdates = [...(item.updates || [])];
            if (item.completed && item.completionDetails) {
              combinedUpdates.push({
                type: "complete",
                text: item.completionDetails.text,
                attachments: item.completionDetails.attachments,
                timestamp: item.completionDetails.timestamp,
              });
            }

            let itemUpdates = combinedUpdates
              .map((u) => ({ ...u, date: parseThaiDateString(u.timestamp) }))
              .filter((u) => u.date)
              .sort((a, b) => a.date - b.date);

            if (itemUpdates.length > 0) {
              summaryContentHTML +=
                '<div class="mt-2 pl-6 pt-2 border-t border-gray-200">';
              summaryContentHTML +=
                '<p class="text-sm font-semibold text-gray-600 mb-2">ความเคลื่อนไหว:</p>';
              summaryContentHTML +=
                '<div class="relative pl-6 border-l-2 border-gray-200 space-y-3 py-1">';
              summaryText += `  ความเคลื่อนไหว:\n`;

              itemUpdates.forEach((update) => {
                const isIssue = update.type === "issue";
                const isComplete = update.type === "complete";
                let icon, color, prefix, mainText;

                if (isIssue) {
                  icon = "fa-triangle-exclamation";
                  color = "bg-red-500";
                  prefix = "แจ้งปัญหา";
                  mainText = update.text;
                } else if (isComplete) {
                  icon = "fa-check-circle";
                  color = "bg-green-500";
                  prefix = "ปิดงาน";
                  mainText = `<strong>ผลการดำเนินงาน:</strong> ${
                    update.text || "ไม่มี"
                  }`;
                } else {
                  icon = "fa-info-circle";
                  color = "bg-blue-500";
                  prefix = "อัพเดต";
                  mainText = update.text;
                }

                summaryContentHTML += `
                                <div class="relative">
                                    <div class="absolute -left-[33.5px] top-1 h-5 w-5 rounded-full ${color} flex items-center justify-center ring-4 ring-white">
                                        <i class="fa-solid ${icon} text-white text-[10px]"></i>
                                    </div>
                                    <div class="text-sm">
                                        <p class="font-medium text-gray-700">${prefix}</p>
                                        <div class="text-gray-600 pl-2">${mainText}</div>
                                        ${createAttachmentsHTML(
                                          update.attachments
                                        )}
                                        <p class="text-xs text-gray-500 mt-1">${update.date.toLocaleString(
                                          "th-TH",
                                          {
                                            dateStyle: "medium",
                                            timeStyle: "short",
                                          }
                                        )}</p>
                                    </div>
                                </div>
                            `;
                summaryText += `    - (${update.date.toLocaleString("th-TH", {
                  dateStyle: "short",
                  timeStyle: "short",
                })}) ${prefix}: ${update.text}\n`;
              });
              summaryContentHTML += "</div></div>";
            }

            summaryContentHTML += `</div>`;
          });

          summaryContentHTML += "</div>";
        } else {
          summaryContentHTML =
            '<p class="text-center text-gray-500">ยังไม่มีรายการเช็คลิสต์ในงานนี้</p>';
        }

        document.getElementById("summaryContent").innerHTML =
          summaryContentHTML;
        document.getElementById("summaryEditable").value = summaryText;

        document.getElementById("summaryAttachments").value = "";
        document.getElementById("summaryAttachmentList").innerHTML = "";

        summaryModal.classList.remove("hidden");
      }

      function showStartupNotification() {
        const lastShown = localStorage.getItem("notificationLastShown");
        const today = new Date().toDateString();

        if (lastShown === today) return; // Don't show again today

        const todayDate = new Date();
        todayDate.setHours(0, 0, 0, 0);

        let allChecklistItems = [];
        if (data && data.categories) {
          data.categories.forEach((cat) => {
            (cat.tasks || []).forEach((task) => {
              (task.checklist || []).forEach((item) => {
                if (!item.completed) {
                  allChecklistItems.push(item);
                }
              });
            });
          });
        }

        const urgentCount = allChecklistItems.filter((i) => i.isUrgent).length;
        const startTodayCount = allChecklistItems.filter(
          (i) =>
            i.startDate &&
            new Date(i.startDate).toDateString() === todayDate.toDateString()
        ).length;
        const dueTodayCount = allChecklistItems.filter(
          (i) =>
            i.dueDate &&
            new Date(i.dueDate).toDateString() === todayDate.toDateString()
        ).length;

        if (urgentCount > 0 || startTodayCount > 0 || dueTodayCount > 0) {
          document.getElementById("notificationUrgentCount").textContent =
            urgentCount;
          document.getElementById("notificationStartTodayCount").textContent =
            startTodayCount;
          document.getElementById("notificationDueTodayCount").textContent =
            dueTodayCount;

          notificationModal.classList.remove("hidden");
          setTimeout(() => {
            notificationModal
              .querySelector("div")
              .classList.remove("scale-95", "opacity-0");
          }, 10);

          localStorage.setItem("notificationLastShown", today);
        }
      }

      closeNotificationBtn.addEventListener("click", () => {
        notificationModal
          .querySelector("div")
          .classList.add("scale-95", "opacity-0");
        setTimeout(() => {
          notificationModal.classList.add("hidden");
        }, 300);
      });

      goToAgendaBtn.addEventListener("click", () => {
        closeModal();
        switchView("agenda");
      });

      openSidebarBtn.addEventListener("click", openSidebar);
      closeSidebarBtn.addEventListener("click", closeSidebar);
      sidebarOverlay.addEventListener("click", closeSidebar);
      addTaskBtn.addEventListener("click", openModalForAdd);
      cancelBtn.addEventListener("click", closeModal);
      closeDetailModalBtn.addEventListener("click", closeModal);
      deleteTaskFromDetailBtn.addEventListener("click", () => {
        const [catIndex, taskIndex] = detailTaskIndicesInput.value
          .split(",")
          .map(Number);
        deleteTask(catIndex, taskIndex);
        closeModal();
      });

      document.querySelectorAll(".stat-card").forEach((card) => {
        card.addEventListener("click", () => {
          const filter = card.dataset.filter;
          let filteredTasks = [];
          const allTasks = data.categories.flatMap((cat, catIndex) =>
            (cat.tasks || []).map((task, taskIndex) => ({
              ...task,
              catIndex,
              taskIndex,
              categoryTitle: cat.title,
            }))
          );

          const allChecklistItems = data.categories.flatMap((cat, catIndex) =>
            (cat.tasks || []).flatMap((task, taskIndex) =>
              (task.checklist || []).map((item) => ({
                ...item,
                parentTask: {
                  ...task,
                  catIndex,
                  taskIndex,
                  categoryTitle: cat.title,
                },
              }))
            )
          );

          const filterMapping = {
            pending: "งานที่รอดำเนินการ",
            "in-progress": "งานที่กำลังดำเนินการ",
            urgent: "งานด่วน",
            completed: "งานที่เสร็จสิ้นแล้ว",
          };

          let title = filterMapping[filter];

          if (filter === "urgent") {
            const urgentParentTaskIds = new Set();
            allChecklistItems
              .filter((item) => item.isUrgent && !item.completed)
              .forEach((item) => {
                urgentParentTaskIds.add(
                  `${item.parentTask.catIndex}-${item.parentTask.taskIndex}`
                );
              });

            filteredTasks = allTasks.filter((task) =>
              urgentParentTaskIds.has(`${task.catIndex}-${task.taskIndex}`)
            );
          } else {
            filteredTasks = allTasks.filter((t) => t.status === filter);
          }

          if (title) {
            renderFilteredView(filteredTasks, title);
          }
        });
      });

      function renderFilteredView(tasks, title) {
        switchView("filteredKanban");
        const content = document.getElementById("filteredKanbanContent");
        content.innerHTML = "";

        const filteredViewTitle = document.createElement("h2");
        filteredViewTitle.className = "text-2xl font-bold mb-4";
        filteredViewTitle.textContent = title;
        content.appendChild(filteredViewTitle);

        if (tasks.length === 0) {
          content.innerHTML +=
            '<p class="text-center text-gray-500">ไม่พบงานที่ตรงกับเงื่อนไข</p>';
          return;
        }

        const taskGrid = document.createElement("div");
        taskGrid.className =
          "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4";

        tasks.forEach((task) => {
          const color = COLORS[task.catIndex % COLORS.length];
          const taskCard = createTaskCard(
            task,
            task.catIndex,
            task.taskIndex,
            color
          );
          taskCard.querySelector(".task-card-content").draggable = false;
          taskCard.querySelector(".task-card-content").style.cursor = "pointer";
          taskGrid.appendChild(taskCard);
        });
        content.appendChild(taskGrid);
      }

      backToDashboardBtn.addEventListener("click", () =>
        switchView("dashboard")
      );

      kanbanBoard.addEventListener("click", (e) => {
        const deleteBtn = e.target.closest(".delete-category-btn");
        if (deleteBtn) {
          const catIndex = e.target.closest(".kanban-column").dataset.catIndex;
          openDeleteCategoryModal(parseInt(catIndex));
        }
        const templateBtn = e.target.closest(".manage-template-btn");
        if (templateBtn) {
          const catIndex = e.target.closest(".kanban-column").dataset.catIndex;
          openTemplateModal(parseInt(catIndex));
        }
      });

      function openDeleteCategoryModal(catIndex) {
        const category = data.categories[catIndex];
        const messageEl = document.getElementById("deleteCategoryMessage");
        const confirmBtn = document.getElementById("confirmDeleteCategoryBtn");
        document.getElementById("deleteCategoryIndex").value = catIndex;

        if (category.tasks && category.tasks.length > 0) {
          messageEl.innerHTML = `ไม่สามารถลบประเภทงาน "<strong>${category.title}</strong>" ได้ เนื่องจากยังมีงานอยู่ <strong>${category.tasks.length}</strong> งาน กรุณาย้ายหรือลบงานทั้งหมดก่อน`;
          confirmBtn.disabled = true;
          confirmBtn.classList.add("opacity-50", "cursor-not-allowed");
        } else {
          messageEl.innerHTML = `คุณแน่ใจหรือไม่ว่าต้องการลบประเภทงาน "<strong>${category.title}</strong>" การกระทำนี้ไม่สามารถย้อนกลับได้`;
          confirmBtn.disabled = false;
          confirmBtn.classList.remove("opacity-50", "cursor-not-allowed");
        }
        deleteCategoryModal.classList.remove("hidden");
      }

      deleteCategoryForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const catIndex = parseInt(
          document.getElementById("deleteCategoryIndex").value
        );
        data.categories.splice(catIndex, 1);
        saveData();
        closeModal();
      });
      cancelDeleteCategoryBtn.addEventListener("click", closeModal);

      function openTemplateModal(catIndex) {
        const category = data.categories[catIndex];
        document.getElementById(
          "templateModalTitle"
        ).textContent = `เทมเพลต: ${category.title}`;
        document.getElementById("templateCategoryIndex").value = catIndex;
        renderTemplateList(catIndex);
        templateModal.classList.remove("hidden");
      }

      function renderTemplateList(catIndex) {
        const listEl = document.getElementById("templateList");
        const template = data.categories[catIndex].checklistTemplate || [];
        listEl.innerHTML = "";
        if (template.length === 0) {
          listEl.innerHTML =
            '<p class="text-center text-gray-500 text-sm">ยังไม่มีเทมเพลต</p>';
          return;
        }
        template.forEach((item, itemIndex) => {
          const itemEl = document.createElement("div");
          itemEl.className =
            "flex items-center justify-between bg-gray-100 p-2 rounded-md";
          itemEl.innerHTML = `
                    <span>${item.text}</span>
                    <button data-item-index="${itemIndex}" class="delete-template-item-btn text-red-400 hover:text-red-600">&times;</button>
                `;
          listEl.appendChild(itemEl);
        });
      }

      addTemplateItemForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const catIndex = parseInt(
          document.getElementById("templateCategoryIndex").value
        );
        const textInput = document.getElementById("newTemplateItemText");
        const text = textInput.value.trim();
        if (text) {
          if (!data.categories[catIndex].checklistTemplate) {
            data.categories[catIndex].checklistTemplate = [];
          }
          data.categories[catIndex].checklistTemplate.push({ text });
          saveData();
          renderTemplateList(catIndex);
          textInput.value = "";
          textInput.focus();
        }
      });

      document.getElementById("templateList").addEventListener("click", (e) => {
        const deleteBtn = e.target.closest(".delete-template-item-btn");
        if (deleteBtn) {
          const catIndex = parseInt(
            document.getElementById("templateCategoryIndex").value
          );
          const itemIndex = parseInt(deleteBtn.dataset.itemIndex);
          data.categories[catIndex].checklistTemplate.splice(itemIndex, 1);
          saveData();
          renderTemplateList(catIndex);
        }
      });

      closeTemplateModalBtn.addEventListener("click", closeModal);

      function openImportNotesModal() {
        importNotesModal.classList.remove("hidden");
        document.getElementById("notes-input-view").classList.remove("hidden");
        document.getElementById("notes-loading-view").classList.add("hidden");
        document.getElementById("notes-review-view").classList.add("hidden");
        document.getElementById("notesInput").value = "";
      }

      importNotesBtn.addEventListener("click", openImportNotesModal);
      closeImportModalBtn.addEventListener("click", closeModal);
      cancelImportBtn.addEventListener("click", closeModal);

      importNotesForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const notes = document.getElementById("notesInput").value.trim();
        if (!notes) return;

        document.getElementById("notes-input-view").classList.add("hidden");
        document
          .getElementById("notes-loading-view")
          .classList.remove("hidden");

        try {
          const tasks = await generateTasksFromNotes(notes);
          renderNotesReview(tasks);
        } catch (error) {
          console.error("Error processing notes:", error);
          document
            .getElementById("notes-input-view")
            .classList.remove("hidden");
        } finally {
          document.getElementById("notes-loading-view").classList.add("hidden");
        }
      });

      confirmImportBtn.addEventListener("click", () => {
        const reviewContainer = document.getElementById("ai-generated-tasks");
        const taskElements = reviewContainer.querySelectorAll(".ai-task-item");

        taskElements.forEach((taskEl) => {
          const taskContent = taskEl
            .querySelector(".ai-task-content-input")
            .value.trim();
          if (!taskContent) return;

          const checklistItems = Array.from(
            taskEl.querySelectorAll(".ai-checklist-item")
          );
          const categoryIndex = parseInt(
            taskEl.querySelector(".task-category-selector").value
          );

          if (isNaN(categoryIndex)) return;

          const newChecklist = checklistItems
            .map((itemLi) => {
              const text = itemLi
                .querySelector(".ai-checklist-text-input")
                .value.trim();
              const startDate = itemLi.querySelector(
                ".ai-checklist-start-date-input"
              ).value;
              const dueDate = itemLi.querySelector(
                ".ai-checklist-date-input"
              ).value;
              if (!text) return null;
              return {
                text: text,
                completed: false,
                startDate: startDate,
                dueDate: dueDate,
                description: "",
                updates: [],
                isUrgent: false,
              };
            })
            .filter(Boolean);

          const newTask = {
            content: taskContent,
            assigner: "",
            coordinator: "",
            status: "pending",
            isUrgent: false,
            history: [],
            isNew: true,
            checklist: newChecklist,
            createdAt: new Date().toISOString(),
          };
          data.categories[categoryIndex].tasks.push(newTask);
        });

        saveData();
        closeModal();
      });

      document
        .getElementById("ai-generated-tasks")
        .addEventListener("click", (e) => {
          if (e.target.closest(".delete-ai-checklist-item-btn")) {
            e.target.closest(".ai-checklist-item").remove();
          }
          if (e.target.closest(".add-ai-checklist-item-btn")) {
            const list = e.target
              .closest(".ai-task-item")
              .querySelector(".ai-checklist-list");
            const newItemEl = document.createElement("li");
            newItemEl.className = "ai-checklist-item flex items-center gap-2";
            newItemEl.innerHTML = `
                    <input type="text" class="ai-checklist-text-input flex-grow shadow-sm border rounded py-1 px-2 text-sm" value="">
                    <input type="date" class="ai-checklist-start-date-input shadow-sm border rounded py-1 px-2 text-sm" title="Start Date">
                    <input type="date" class="ai-checklist-date-input shadow-sm border rounded py-1 px-2 text-sm" title="Due Date">
                    <button type="button" class="delete-ai-checklist-item-btn text-red-400 hover:text-red-600 shrink-0">&times;</button>
                `;
            list.appendChild(newItemEl);
          }
        });

      function renderNotesReview(tasks) {
        const reviewContainer = document.getElementById("ai-generated-tasks");
        reviewContainer.innerHTML = "";

        if (!tasks || tasks.length === 0) {
          reviewContainer.innerHTML = `<p class="text-center text-gray-500 p-4">AI ไม่สามารถสร้างงานจากข้อความที่ให้ได้ ลองปรับแก้ข้อความและลองใหม่อีกครั้ง</p>`;
          return;
        }

        tasks.forEach((task) => {
          const taskEl = document.createElement("div");
          taskEl.className = "ai-task-item bg-white p-4 rounded-lg border";

          let checklistHTML = '<ul class="ai-checklist-list space-y-2 mt-2">';
          task.checklist.forEach((item) => {
            checklistHTML += `
                        <li class="ai-checklist-item flex items-center gap-2">
                            <input type="text" class="ai-checklist-text-input flex-grow shadow-sm border rounded py-1 px-2 text-sm" value="${item}">
                            <input type="date" class="ai-checklist-start-date-input shadow-sm border rounded py-1 px-2 text-sm" title="Start Date">
                            <input type="date" class="ai-checklist-date-input shadow-sm border rounded py-1 px-2 text-sm" title="Due Date">
                            <button type="button" class="delete-ai-checklist-item-btn text-red-400 hover:text-red-600 shrink-0">&times;</button>
                        </li>
                    `;
          });
          checklistHTML += "</ul>";

          let categoryOptions = data.categories
            .map(
              (cat, catIndex) =>
                `<option value="${catIndex}">${cat.title}</option>`
            )
            .join("");

          taskEl.innerHTML = `
                    <div class="flex flex-col gap-2">
                        <div class="flex justify-between items-center gap-2">
                            <input type="text" class="ai-task-content-input font-bold text-lg text-gray-800 border-b-2 border-transparent focus:border-violet-400 focus:outline-none w-full" value="${task.content}">
                            <select class="task-category-selector shadow-sm border rounded py-1 px-2 text-sm shrink-0">
                                ${categoryOptions}
                            </select>
                        </div>
                        <div class="pl-2">
                            ${checklistHTML}
                            <button type="button" class="add-ai-checklist-item-btn text-sm text-blue-500 hover:text-blue-700 mt-2 flex items-center gap-1">
                                <i class="fa-solid fa-plus fa-xs"></i> เพิ่มรายการ
                            </button>
                        </div>
                    </div>
                `;
          reviewContainer.appendChild(taskEl);
        });
        document.getElementById("notes-review-view").classList.remove("hidden");
      }

      async function generateTasksFromNotes(notes) {
        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        const systemPrompt =
          "You are an intelligent task management assistant. Your goal is to analyze unstructured Thai text notes and convert them into a structured JSON format. The JSON should contain an array of tasks. Each task must have a `content` (a concise title for the task in Thai) and a `checklist` (an array of detailed, actionable steps in Thai). Identify distinct tasks and break them down into smaller sub-tasks for the checklist.";

        const payload = {
          contents: [{ parts: [{ text: notes }] }],
          systemInstruction: { parts: [{ text: systemPrompt }] },
          generationConfig: {
            responseMimeType: "application/json",
            responseSchema: {
              type: "ARRAY",
              items: {
                type: "OBJECT",
                properties: {
                  content: { type: "STRING" },
                  checklist: {
                    type: "ARRAY",
                    items: { type: "STRING" },
                  },
                },
                required: ["content", "checklist"],
              },
            },
          },
        };

        try {
          const response = await fetch(apiUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!response.ok) {
            const errorBody = await response.text();
            throw new Error(
              `API request failed with status ${response.status}: ${errorBody}`
            );
          }

          const result = await response.json();

          if (
            result.candidates &&
            result.candidates[0].content &&
            result.candidates[0].content.parts[0].text
          ) {
            const jsonText = result.candidates[0].content.parts[0].text;
            return JSON.parse(jsonText);
          } else {
            console.error("Unexpected API response structure:", result);
            return [];
          }
        } catch (error) {
          console.error("Error calling Gemini API:", error);
          throw error;
        }
      }

      exportSummaryJsonBtn.addEventListener("click", exportSingleTaskAsJSON);
      exportSummaryCsvBtn.addEventListener("click", exportSingleTaskAsCSV);

      function exportSingleTaskAsJSON() {
        if (!currentTaskForSummary) return;
        const dataStr = JSON.stringify(currentTaskForSummary, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        const safeFileName = currentTaskForSummary.content
          .substring(0, 20)
          .replace(/[^a-z0-9]/gi, "_")
          .toLowerCase();
        a.href = url;
        a.download = `task_${safeFileName}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      function exportSingleTaskAsCSV() {
        if (!currentTaskForSummary) return;

        let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // Add BOM
        const header = [
          "Category",
          "Task Content",
          "Task Status",
          "Checklist Item",
          "Checklist Start Date",
          "Checklist Due Date",
          "Checklist Status",
        ];
        csvContent += header.join(",") + "\r\n";

        const escapeCSV = (str) => {
          if (str === null || str === undefined) return "";
          let result = String(str);
          if (
            result.includes(",") ||
            result.includes('"') ||
            result.includes("\n")
          ) {
            result = '"' + result.replace(/"/g, '""') + '"';
          }
          return result;
        };

        const task = currentTaskForSummary;
        if (task.checklist && task.checklist.length > 0) {
          task.checklist.forEach((item) => {
            const row = [
              escapeCSV(task.categoryTitle),
              escapeCSV(task.content),
              escapeCSV(task.status),
              escapeCSV(item.text),
              escapeCSV(item.startDate),
              escapeCSV(item.dueDate),
              item.completed ? "Completed" : "Pending",
            ];
            csvContent += row.join(",") + "\r\n";
          });
        } else {
          const row = [
            escapeCSV(task.categoryTitle),
            escapeCSV(task.content),
            escapeCSV(task.status),
            "N/A",
            "N/A",
            "N/A",
            "N/A",
          ];
          csvContent += row.join(",") + "\r\n";
        }

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        const safeFileName = currentTaskForSummary.content
          .substring(0, 20)
          .replace(/[^a-z0-9]/gi, "_")
          .toLowerCase();
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `task_${safeFileName}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      shareBtn.addEventListener("click", () => {
        const urlToCopy = window.location.href;
        const textArea = document.createElement("textarea");
        textArea.value = urlToCopy;
        document.body.appendChild(textArea);
        textArea.select();
        try {
          document.execCommand("copy");
          showToast("คัดลอกลิงก์สำหรับแชร์แล้ว!");
        } catch (err) {
          console.error("Fallback: Oops, unable to copy", err);
          // Fallback for browsers that don't support execCommand
          showToast("ไม่สามารถคัดลอกได้");
        }
        document.body.removeChild(textArea);
      });

      // Initial setup on window load
      window.onload = () => {
        // The first render is now triggered by the Firebase onSnapshot listener
        setTimeout(showStartupNotification, 1500); // Delay notification check slightly
      };
    </script>
  </body>
</html>
